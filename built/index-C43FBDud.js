(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class Di{angleX=0;angleY=0;angleZ=0;angleEyeX=0;angleEyeY=0;mouseDistance=0;autoBlink=!1}const Vt=class Vt{constructor(t=0){t<1?(this._ptr=[],this._capacity=0,this._size=0):(this._ptr=new Array(t),this._capacity=t,this._size=0)}at(t){return this._ptr[t]}set(t,e){this._ptr[t]=e}get(t=0){const e=new Array;for(let i=t;i<this._size;i++)e.push(this._ptr[i]);return e}pushBack(t){this._size>=this._capacity&&this.prepareCapacity(this._capacity==0?Vt.DefaultSize:this._capacity*2),this._ptr[this._size++]=t}clear(){this._ptr.length=0,this._size=0}getSize(){return this._size}assign(t,e){this._size<t&&this.prepareCapacity(t);for(let s=0;s<t;s++)this._ptr[s]=e;this._size=t}resize(t,e=null){this.updateSize(t,e,!0)}updateSize(t,e=null,i=!0){if(this._size<t)if(this.prepareCapacity(t),i)for(let a=this._size;a<t;a++)typeof e=="function"?this._ptr[a]=JSON.parse(JSON.stringify(new e)):this._ptr[a]=e;else for(let a=this._size;a<t;a++)this._ptr[a]=e;else{const a=this._size-t;this._ptr.splice(this._size-a,a)}this._size=t}insert(t,e,i){let s=t._index;const a=e._index,n=i._index,o=n-a;this.prepareCapacity(this._size+o);const l=this._size-s;if(l>0)for(let u=0;u<l;u++)this._ptr.splice(s+u,0,null);for(let u=a;u<n;u++,s++)this._ptr[s]=e._vector._ptr[u];this._size=this._size+o}remove(t){return t<0||this._size<=t?!1:(this._ptr.splice(t,1),--this._size,!0)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._ptr.splice(e,1),--this._size,new jt(this,e))}prepareCapacity(t){t>this._capacity&&(this._capacity==0?(this._ptr=new Array(t),this._capacity=t):(this._ptr.length=t,this._capacity=t))}begin(){return this._size==0?this.end():new jt(this,0)}end(){return new jt(this,this._size)}getOffset(t){const e=new Vt;return e._ptr=this.get(t),e._size=this.get(t).length,e._capacity=this.get(t).length,e}};Vt.DefaultSize=10;let x=Vt,jt=class ue{constructor(t,e){this._vector=t??null,this._index=e??0}set(t){return this._index=t._index,this._vector=t._vector,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new ue(this._vector,this._index++)}decrement(){return new ue(this._vector,this._index--)}ptr(){return this._vector._ptr[this._index]}substitution(t){return this._index=t._index,this._vector=t._vector,this}notEqual(t){return this._index!=t._index||this._vector!=t._vector}};var he;(r=>{r.csmVector=x,r.iterator=jt})(he||(he={}));class X{append(t,e){return this.s+=e!==void 0?t.substr(0,e):t,this}expansion(t,e){for(let i=0;i<t;i++)this.append(e);return this}getBytes(){return encodeURIComponent(this.s).replace(/%../g,"x").length}getLength(){return this.s.length}isLess(t){return this.s<t.s}isGreat(t){return this.s>t.s}isEqual(t){return this.s==t}isEmpty(){return this.s.length==0}constructor(t){this.s=t}}var Re;(r=>{r.csmString=X})(Re||(Re={}));class yt{static createIdInternal(t){return new yt(t)}getString(){return this._id}isEqual(t){return typeof t=="string"?this._id.isEqual(t):t instanceof X?this._id.isEqual(t.s):t instanceof yt?this._id.isEqual(t._id.s):!1}isNotEqual(t){return typeof t=="string"?!this._id.isEqual(t):t instanceof X?!this._id.isEqual(t.s):t instanceof yt?!this._id.isEqual(t._id.s):!1}constructor(t){if(typeof t=="string"){this._id=new X(t);return}this._id=t}}var Ee;(r=>{r.CubismId=yt})(Ee||(Ee={}));class Li{constructor(){this._ids=new x}release(){for(let t=0;t<this._ids.getSize();++t)this._ids.set(t,void 0);this._ids=null}registerIds(t){for(let e=0;e<t.length;e++)this.registerId(t[e])}registerId(t){let e=null;if(typeof t=="string"){if((e=this.findId(t))!=null)return e;e=yt.createIdInternal(t),this._ids.pushBack(e)}else return this.registerId(t.s);return e}getId(t){return this.registerId(t)}isExist(t){return typeof t=="string"?this.findId(t)!=null:this.isExist(t.s)}findId(t){for(let e=0;e<this._ids.getSize();++e)if(this._ids.at(e).getString().isEqual(t))return this._ids.at(e);return null}}var De;(r=>{r.CubismIdManager=Li})(De||(De={}));let et=class Bt{constructor(){this._tr=new Float32Array(16),this.loadIdentity()}static multiply(t,e,i){const s=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),a=4;for(let n=0;n<a;++n)for(let o=0;o<a;++o)for(let l=0;l<a;++l)s[o+n*4]+=t[l+n*4]*e[o+l*4];for(let n=0;n<16;++n)i[n]=s[n]}loadIdentity(){const t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(t)}setMatrix(t){for(let e=0;e<16;++e)this._tr[e]=t[e]}getArray(){return this._tr}getScaleX(){return this._tr[0]}getScaleY(){return this._tr[5]}getTranslateX(){return this._tr[12]}getTranslateY(){return this._tr[13]}transformX(t){return this._tr[0]*t+this._tr[12]}transformY(t){return this._tr[5]*t+this._tr[13]}invertTransformX(t){return(t-this._tr[12])/this._tr[0]}invertTransformY(t){return(t-this._tr[13])/this._tr[5]}translateRelative(t,e){const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]);Bt.multiply(i,this._tr,this._tr)}translate(t,e){this._tr[12]=t,this._tr[13]=e}translateX(t){this._tr[12]=t}translateY(t){this._tr[13]=t}scaleRelative(t,e){const i=new Float32Array([t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]);Bt.multiply(i,this._tr,this._tr)}scale(t,e){this._tr[0]=t,this._tr[5]=e}multiplyByMatrix(t){Bt.multiply(t.getArray(),this._tr,this._tr)}clone(){const t=new Bt;for(let e=0;e<this._tr.length;e++)t._tr[e]=this._tr[e];return t}};var ge;(r=>{r.CubismMatrix44=et})(ge||(ge={}));class Xt{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}getCenterX(){return this.x+.5*this.width}getCenterY(){return this.y+.5*this.height}getRight(){return this.x+this.width}getBottom(){return this.y+this.height}setRect(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}expand(t,e){this.x-=t,this.y-=e,this.width+=t*2,this.height+=e*2}}var Le;(r=>{r.csmRect=Xt})(Le||(Le={}));class Jt{static create(){return null}static delete(t){}initialize(t){this._model=t}drawModel(){this.getModel()!=null&&(this.saveProfile(),this.doDrawModel(),this.restoreProfile())}setMvpMatrix(t){this._mvpMatrix4x4.setMatrix(t.getArray())}getMvpMatrix(){return this._mvpMatrix4x4}setModelColor(t,e,i,s){t<0?t=0:t>1&&(t=1),e<0?e=0:e>1&&(e=1),i<0?i=0:i>1&&(i=1),s<0?s=0:s>1&&(s=1),this._modelColor.r=t,this._modelColor.g=e,this._modelColor.b=i,this._modelColor.a=s}getModelColor(){return JSON.parse(JSON.stringify(this._modelColor))}getModelColorWithOpacity(t){const e=this.getModelColor();return e.a*=t,this.isPremultipliedAlpha()&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}setIsPremultipliedAlpha(t){this._isPremultipliedAlpha=t}isPremultipliedAlpha(){return this._isPremultipliedAlpha}setIsCulling(t){this._isCulling=t}isCulling(){return this._isCulling}setAnisotropy(t){this._anisotropy=t}getAnisotropy(){return this._anisotropy}getModel(){return this._model}useHighPrecisionMask(t){this._useHighPrecisionMask=t}isUsingHighPrecisionMask(){return this._useHighPrecisionMask}constructor(){this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisotropy=0,this._model=null,this._modelColor=new k,this._useHighPrecisionMask=!1,this._mvpMatrix4x4=new et,this._mvpMatrix4x4.loadIdentity()}}var it=(r=>(r[r.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",r[r.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",r[r.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative",r))(it||{});class k{constructor(t=1,e=1,i=1,s=1){this.r=t,this.g=e,this.b=i,this.a=s}}class Ps{constructor(t,e){this._clippingIdList=t,this._clippingIdCount=e,this._allClippedDrawRect=new Xt,this._layoutBounds=new Xt,this._clippedDrawableIndexList=[],this._matrixForMask=new et,this._matrixForDraw=new et,this._bufferIndex=0}release(){this._layoutBounds!=null&&(this._layoutBounds=null),this._allClippedDrawRect!=null&&(this._allClippedDrawRect=null),this._clippedDrawableIndexList!=null&&(this._clippedDrawableIndexList=null)}addClippedDrawable(t){this._clippedDrawableIndexList.push(t)}}var Oe;(r=>{r.CubismBlendMode=it,r.CubismRenderer=Jt,r.CubismTextureColor=k})(Oe||(Oe={}));const vs=(r,t,e)=>{ve.print(r,"[CSM]"+t,e)},Lt=(r,t,e)=>{vs(r,t+`
`,e)},A=r=>{console.assert(r)};let Ft,j,B,w;Ft=(r,...t)=>{Lt(mt.LogLevel_Debug,"[D]"+r,t)},j=(r,...t)=>{Lt(mt.LogLevel_Info,"[I]"+r,t)},B=(r,...t)=>{Lt(mt.LogLevel_Warning,"[W]"+r,t)},w=(r,...t)=>{Lt(mt.LogLevel_Error,"[E]"+r,t)};class ve{static print(t,e,i){if(t<I.getLoggingLevel())return;const s=I.coreLogFunction;if(!s)return;const a=e.replace(/\{(\d+)\}/g,(n,o)=>i[o]);s(a)}static dumpBytes(t,e,i){for(let s=0;s<i;s++)s%16==0&&s>0?this.print(t,`
`):s%8==0&&s>0&&this.print(t,"  "),this.print(t,"{0} ",[e[s]&255]);this.print(t,`
`)}constructor(){}}var Ae;(r=>{r.CubismDebug=ve})(Ae||(Ae={}));class Oi{constructor(t,e){this.first=t??null,this.second=e??null}}const It=class It{constructor(t){t!=null?t<1?(this._keyValues=[],this._dummyValue=null,this._size=0):(this._keyValues=new Array(t),this._size=t):(this._keyValues=[],this._dummyValue=null,this._size=0)}release(){this.clear()}appendKey(t){let e=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==t){e=i;break}if(e!=-1){B("The key `{0}` is already append.",t);return}this.prepareCapacity(this._size+1,!1),this._keyValues[this._size]=new Oi(t),this._size+=1}getValue(t){let e=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==t){e=i;break}return e>=0?this._keyValues[e].second:(this.appendKey(t),this._keyValues[this._size-1].second)}setValue(t,e){let i=-1;for(let s=0;s<this._size;s++)if(this._keyValues[s].first==t){i=s;break}i>=0?this._keyValues[i].second=e:(this.appendKey(t),this._keyValues[this._size-1].second=e)}isExist(t){for(let e=0;e<this._size;e++)if(this._keyValues[e].first==t)return!0;return!1}clear(){this._keyValues=void 0,this._keyValues=null,this._keyValues=[],this._size=0}getSize(){return this._size}prepareCapacity(t,e){t>this._keyValues.length&&(this._keyValues.length==0?(!e&&t<It.DefaultSize&&(t=It.DefaultSize),this._keyValues.length=t):(!e&&t<this._keyValues.length*2&&(t=this._keyValues.length*2),this._keyValues.length=t))}begin(){return new lt(this,0)}end(){return new lt(this,this._size)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._keyValues.splice(e,1),--this._size,new lt(this,e))}dumpAsInt(){for(let t=0;t<this._size;t++)Ft("{0} ,",this._keyValues[t]),Ft(`
`)}};It.DefaultSize=10;let H=It;class lt{constructor(t,e){this._map=t??new H,this._index=e??0}set(t){return this._index=t._index,this._map=t._map,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new lt(this._map,this._index++)}decrement(){const t=new lt(this._map,this._index);return this._map=t._map,this._index=t._index,this}ptr(){return this._map._keyValues[this._index]}notEqual(t){return this._index!=t._index||this._map!=t._map}}var ke;(r=>{r.csmMap=H,r.csmPair=Oi,r.iterator=lt})(ke||(ke={}));class Gt{static parseJsonObject(t,e){return Object.keys(t).forEach(i=>{if(typeof t[i]=="boolean"){const s=!!t[i];e.put(i,new q(s))}else if(typeof t[i]=="string"){const s=String(t[i]);e.put(i,new St(s))}else if(typeof t[i]=="number"){const s=Number(t[i]);e.put(i,new Wt(s))}else t[i]instanceof Array?e.put(i,Gt.parseJsonArray(t[i])):t[i]instanceof Object?e.put(i,Gt.parseJsonObject(t[i],new xt)):t[i]==null?e.put(i,new Ct):e.put(i,t[i])}),e}static parseJsonArray(t){const e=new Be;return Object.keys(t).forEach(i=>{if(typeof Number(i)=="number")if(typeof t[i]=="boolean"){const a=!!t[i];e.add(new q(a))}else if(typeof t[i]=="string"){const a=String(t[i]);e.add(new St(a))}else if(typeof t[i]=="number"){const a=Number(t[i]);e.add(new Wt(a))}else t[i]instanceof Array?e.add(this.parseJsonArray(t[i])):t[i]instanceof Object?e.add(this.parseJsonObject(t[i],new xt)):t[i]==null?e.add(new Ct):e.add(t[i]);else if(t[i]instanceof Array)e.add(this.parseJsonArray(t[i]));else if(t[i]instanceof Object)e.add(this.parseJsonObject(t[i],new xt));else if(t[i]==null)e.add(new Ct);else{const a=Array(t[i]);for(let n=0;n<a.length;n++)e.add(a[n])}}),e}}const Yt="Error: type mismatch",Bs="Error: index out of bounds";let O=class J{constructor(){}getRawString(t,e){return this.getString(t,e)}toInt(t=0){return t}toFloat(t=0){return t}toBoolean(t=!1){return t}getSize(){return 0}getArray(t=null){return t}getVector(t=new x){return t}getMap(t){return t}getValueByIndex(t){return J.errorValue.setErrorNotForClientCall(Yt)}getValueByString(t){return J.nullValue.setErrorNotForClientCall(Yt)}getKeys(){return J.dummyKeys}isError(){return!1}isNull(){return!1}isBool(){return!1}isFloat(){return!1}isString(){return!1}isArray(){return!1}isMap(){return!1}equals(t){return!1}isStatic(){return!1}setErrorNotForClientCall(t){return wt.errorValue}static staticInitializeNotForClientCall(){q.trueValue=new q(!0),q.falseValue=new q(!1),J.errorValue=new wt("ERROR",!0),J.nullValue=new Ct,J.dummyKeys=new x}static staticReleaseNotForClientCall(){q.trueValue=null,q.falseValue=null,J.errorValue=null,J.nullValue=null,J.dummyKeys=null}};class D{constructor(t,e){this._parseCallback=Gt.parseJsonObject,this._error=null,this._lineCount=0,this._root=null,t!=null&&this.parseBytes(t,e,this._parseCallback)}static create(t,e){const i=new D;return i.parseBytes(t,e,i._parseCallback)?i:(D.delete(i),null)}static delete(t){}getRoot(){return this._root}static arrayBufferToString(t){const e=new Uint8Array(t);let i="";for(let s=0,a=e.length;s<a;++s)i+="%"+this.pad(e[s].toString(16));return i=decodeURIComponent(i),i}static pad(t){return t.length<2?"0"+t:t}parseBytes(t,e,i){const s=new Array(1),a=D.arrayBufferToString(t);if(i==null?this._root=this.parseValue(a,e,0,s):this._root=i(JSON.parse(a),new xt),this._error){let n="\0";return n="Json parse error : @line "+(this._lineCount+1)+`
`,this._root=new St(n),j("{0}",this._root.getRawString()),!1}else if(this._root==null)return this._root=new wt(new X(this._error),!1),!1;return!0}getParseError(){return this._error}checkEndOfFile(){return this._root.getArray()[1].equals("EOF")}parseValue(t,e,i,s){if(this._error)return null;let a=null,n=i,o;for(;n<e;n++)switch(t[n]){case"-":case".":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const u=new Array(1);return o=Vs(t.slice(n),u),s[0]=t.indexOf(u[0]),new Wt(o)}case'"':return new St(this.parseString(t,e,n+1,s));case"[":return a=this.parseArray(t,e,n+1,s),a;case"{":return a=this.parseObject(t,e,n+1,s),a;case"n":return n+3<e?(a=new Ct,s[0]=n+4):this._error="parse null",a;case"t":return n+3<e?(a=q.trueValue,s[0]=n+4):this._error="parse true",a;case"f":return n+4<e?(a=q.falseValue,s[0]=n+5):this._error="illegal ',' position",a;case",":return this._error="illegal ',' position",null;case"]":return s[0]=n,null;case`
`:this._lineCount++}return this._error="illegal end of value",null}parseString(t,e,i,s){if(this._error)return null;if(!t)return this._error="string is null",null;let a=i,n,o;const l=new X("");let u=i;for(;a<e;a++)switch(n=t[a],n){case'"':return s[0]=a+1,l.append(t.slice(u),a-u),l.s;case"//":if(a++,a-1>u&&l.append(t.slice(u),a-u),u=a+1,a<e)switch(o=t[a],o){case"\\":l.expansion(1,"\\");break;case'"':l.expansion(1,'"');break;case"/":l.expansion(1,"/");break;case"b":l.expansion(1,"\b");break;case"f":l.expansion(1,"\f");break;case"n":l.expansion(1,`
`);break;case"r":l.expansion(1,"\r");break;case"t":l.expansion(1,"	");break;case"u":this._error="parse string/unicord escape not supported";break}else this._error="parse string/escape error"}return this._error="parse string/illegal end",null}parseObject(t,e,i,s){if(this._error)return null;if(!t)return this._error="buffer is null",null;const a=new xt;let n="",o=i,l="";const u=Array(1);let h=!1;for(;o<e;o++){t:for(;o<e;o++)switch(l=t[o],l){case'"':if(n=this.parseString(t,e,o+1,u),this._error)return null;o=u[0],h=!0;break t;case"}":return s[0]=o+1,a;case":":this._error="illegal ':' position";break;case`
`:this._lineCount++}if(!h)return this._error="key not found",null;h=!1;t:for(;o<e;o++)switch(l=t[o],l){case":":h=!0,o++;break t;case"}":this._error="illegal '}' position";break;case`
`:this._lineCount++}if(!h)return this._error="':' not found",null;const g=this.parseValue(t,e,o,u);if(this._error)return null;o=u[0],a.put(n,g);t:for(;o<e;o++)switch(l=t[o],l){case",":break t;case"}":return s[0]=o+1,a;case`
`:this._lineCount++}}return this._error="illegal end of perseObject",null}parseArray(t,e,i,s){if(this._error)return null;if(!t)return this._error="buffer is null",null;let a=new Be,n=i,o;const l=new Array(1);for(;n<e;n++){const u=this.parseValue(t,e,n,l);if(this._error)return null;n=l[0],u&&a.add(u);t:for(;n<e;n++)switch(o=t[n],o){case",":break t;case"]":return s[0]=n+1,a;case`
`:++this._lineCount}}return a=void 0,this._error="illegal end of parseObject",null}}class Wt extends O{constructor(t){super(),this._value=t}isFloat(){return!0}getString(t,e){return this._value=parseFloat("\0"),this._stringBuffer="\0",this._stringBuffer}toInt(t=0){return parseInt(this._value.toString())}toFloat(t=0){return this._value}equals(t){return typeof t=="number"?Math.round(t)?!1:t==this._value:!1}}class q extends O{isBool(){return!0}toBoolean(t=!1){return this._boolValue}getString(t,e){return this._stringBuffer=this._boolValue?"true":"false",this._stringBuffer}equals(t){return typeof t=="boolean"?t==this._boolValue:!1}isStatic(){return!0}constructor(t){super(),this._boolValue=t}}class St extends O{constructor(t){super(),typeof t=="string"&&(this._stringBuffer=t),t instanceof X&&(this._stringBuffer=t.s)}isString(){return!0}getString(t,e){return this._stringBuffer}equals(t){return typeof t=="string"?this._stringBuffer==t:t instanceof X?this._stringBuffer==t.s:!1}}class wt extends St{isStatic(){return this._isStatic}setErrorNotForClientCall(t){return this._stringBuffer=t,this}constructor(t,e){typeof t=="string"?super(t):super(t),this._isStatic=e}isError(){return!0}}class Ct extends O{isNull(){return!0}getString(t,e){return this._stringBuffer}isStatic(){return!0}setErrorNotForClientCall(t){return this._stringBuffer=t,wt.nullValue}constructor(){super(),this._stringBuffer="NullValue"}}class Be extends O{constructor(){super(),this._array=new x}release(){for(let t=this._array.begin();t.notEqual(this._array.end());t.preIncrement()){let e=t.ptr();e&&!e.isStatic()&&(e=void 0,e=null)}}isArray(){return!0}getValueByIndex(t){if(t<0||this._array.getSize()<=t)return O.errorValue.setErrorNotForClientCall(Bs);const e=this._array.at(t);return e??O.nullValue}getValueByString(t){return O.errorValue.setErrorNotForClientCall(Yt)}getString(t,e){const i=e+`[
`;for(let s=this._array.begin();s.notEqual(this._array.end());s.increment()){const a=s.ptr();this._stringBuffer+=e+""+a.getString(e+" ")+`
`}return this._stringBuffer=i+e+`]
`,this._stringBuffer}add(t){this._array.pushBack(t)}getVector(t=null){return this._array}getSize(){return this._array.getSize()}}class xt extends O{constructor(){super(),this._map=new H}release(){const t=this._map.begin();for(;t.notEqual(this._map.end());){let e=t.ptr().second;e&&!e.isStatic()&&(e=void 0,e=null),t.preIncrement()}}isMap(){return!0}getValueByString(t){if(t instanceof X){const e=this._map.getValue(t.s);return e??O.nullValue}for(let e=this._map.begin();e.notEqual(this._map.end());e.preIncrement())if(e.ptr().first==t)return e.ptr().second==null?O.nullValue:e.ptr().second;return O.nullValue}getValueByIndex(t){return O.errorValue.setErrorNotForClientCall(Yt)}getString(t,e){this._stringBuffer=e+`{
`;const i=this._map.begin();for(;i.notEqual(this._map.end());){const s=i.ptr().first,a=i.ptr().second;this._stringBuffer+=e+" "+s+" : "+a.getString(e+"   ")+` 
`,i.preIncrement()}return this._stringBuffer+=e+`}
`,this._stringBuffer}getMap(t){return this._map}put(t,e){this._map.setValue(t,e)}getKeys(){if(!this._keys){this._keys=new x;const t=this._map.begin();for(;t.notEqual(this._map.end());){const e=t.ptr().first;this._keys.pushBack(e),t.preIncrement()}}return this._keys}getSize(){return this._keys.getSize()}}var Ue;(r=>{r.CubismJson=D,r.JsonArray=Be,r.JsonBoolean=q,r.JsonError=wt,r.JsonFloat=Wt,r.JsonMap=xt,r.JsonNullvalue=Ct,r.JsonString=St,r.Value=O})(Ue||(Ue={}));function Vs(r,t){let e=0;for(let s=1;;s++){const a=r.slice(s-1,s);if(a=="e"||a=="-"||a=="E")continue;const n=r.substring(0,s),o=Number(n);if(isNaN(o))break;e=s}let i=parseFloat(r);return isNaN(i)&&(i=NaN),t[0]=r.slice(e),i}let Y=!1,ut=!1,ht=null,bt=null;const tt=Object.freeze({vertexOffset:0,vertexStep:2});function _t(r){r&&(r=void 0)}let I=class{static startUp(t=null){if(Y)return j("CubismFramework.startUp() is already done."),Y;if(ht=t,ht!=null&&Live2DCubismCore.Logging.csmSetLogFunction(ht.logFunction),Y=!0,Y){const e=Live2DCubismCore.Version.csmGetVersion(),i=(e&4278190080)>>24,s=(e&16711680)>>16,a=e&65535,n=e;j("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+i).slice(-2),("00"+s).slice(-2),("0000"+a).slice(-4),n)}return j("CubismFramework.startUp() is complete."),Y}static cleanUp(){Y=!1,ut=!1,ht=null,bt=null}static initialize(t=0){if(A(Y),!Y){B("CubismFramework is not started.");return}if(ut){B("CubismFramework.initialize() skipped, already initialized.");return}O.staticInitializeNotForClientCall(),bt=new Li,Live2DCubismCore.Memory.initializeAmountOfMemory(t),ut=!0,j("CubismFramework.initialize() is complete.")}static dispose(){if(A(Y),!Y){B("CubismFramework is not started.");return}if(!ut){B("CubismFramework.dispose() skipped, not initialized.");return}O.staticReleaseNotForClientCall(),bt.release(),bt=null,Jt.staticRelease(),ut=!1,j("CubismFramework.dispose() is complete.")}static isStarted(){return Y}static isInitialized(){return ut}static coreLogFunction(t){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(t)}static getLoggingLevel(){return ht!=null?ht.loggingLevel:5}static getIdManager(){return bt}constructor(){}};var mt=(r=>(r[r.LogLevel_Verbose=0]="LogLevel_Verbose",r[r.LogLevel_Debug=1]="LogLevel_Debug",r[r.LogLevel_Info=2]="LogLevel_Info",r[r.LogLevel_Warning=3]="LogLevel_Warning",r[r.LogLevel_Error=4]="LogLevel_Error",r[r.LogLevel_Off=5]="LogLevel_Off",r))(mt||{}),Ne;(r=>{r.Constant=tt,r.csmDelete=_t,r.CubismFramework=I})(Ne||(Ne={}));let Ai=class{};var ce;(r=>{r.ICubismModelSetting=Ai})(ce||(ce={}));var ki=(r=>(r[r.FrequestNode_Groups=0]="FrequestNode_Groups",r[r.FrequestNode_Moc=1]="FrequestNode_Moc",r[r.FrequestNode_Motions=2]="FrequestNode_Motions",r[r.FrequestNode_Expressions=3]="FrequestNode_Expressions",r[r.FrequestNode_Textures=4]="FrequestNode_Textures",r[r.FrequestNode_Physics=5]="FrequestNode_Physics",r[r.FrequestNode_Pose=6]="FrequestNode_Pose",r[r.FrequestNode_HitAreas=7]="FrequestNode_HitAreas",r))(ki||{});let Is=class extends Ai{constructor(t,e){super(),this.version="Version",this.fileReferences="FileReferences",this.groups="Groups",this.layout="Layout",this.hitAreas="HitAreas",this.moc="Moc",this.textures="Textures",this.physics="Physics",this.pose="Pose",this.expressions="Expressions",this.motions="Motions",this.userData="UserData",this.name="Name",this.filePath="File",this.id="Id",this.ids="Ids",this.target="Target",this.idle="Idle",this.tapBody="TapBody",this.pinchIn="PinchIn",this.pinchOut="PinchOut",this.shake="Shake",this.flickHead="FlickHead",this.parameter="Parameter",this.soundPath="Sound",this.fadeInTime="FadeInTime",this.fadeOutTime="FadeOutTime",this.centerX="CenterX",this.centerY="CenterY",this.x="X",this.y="Y",this.width="Width",this.height="Height",this.lipSync="LipSync",this.eyeBlink="EyeBlink",this.initParameter="init_param",this.initPartsVisible="init_parts_visible",this.val="val",this._json=D.create(t,e),this.getJson()&&(this._jsonValue=new x,this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.groups)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.moc)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.motions)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.expressions)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.textures)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.physics)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.pose)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.hitAreas)))}release(){D.delete(this._json),this._jsonValue=null}getJson(){return this._json}getModelFileName(){return this.isExistModelFile()?this._jsonValue.at(1).getRawString():""}getTextureCount(){return this.isExistTextureFiles()?this._jsonValue.at(4).getSize():0}getTextureDirectory(){const e=this._jsonValue.at(4).getValueByIndex(0).getRawString().split("/"),i=e.length-1;let s="";for(let a=0;a<i;a++)s+=e[a],a<i-1&&(s+="/");return s}getTextureFileName(t){return this._jsonValue.at(4).getValueByIndex(t).getRawString()}getHitAreasCount(){return this.isExistHitAreas()?this._jsonValue.at(7).getSize():0}getHitAreaId(t){return I.getIdManager().getId(this._jsonValue.at(7).getValueByIndex(t).getValueByString(this.id).getRawString())}getHitAreaName(t){return this._jsonValue.at(7).getValueByIndex(t).getValueByString(this.name).getRawString()}getPhysicsFileName(){return this.isExistPhysicsFile()?this._jsonValue.at(5).getRawString():""}getPoseFileName(){return this.isExistPoseFile()?this._jsonValue.at(6).getRawString():""}getExpressionCount(){return this.isExistExpressionFile()?this._jsonValue.at(3).getSize():0}getExpressionName(t){return this._jsonValue.at(3).getValueByIndex(t).getValueByString(this.name).getRawString()}getExpressionFileName(t){return this._jsonValue.at(3).getValueByIndex(t).getValueByString(this.filePath).getRawString()}getMotionGroupCount(){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().getSize():0}getMotionGroupName(t){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().at(t):null}getMotionCount(t){return this.isExistMotionGroupName(t)?this._jsonValue.at(2).getValueByString(t).getSize():0}getMotionFileName(t,e){return this.isExistMotionGroupName(t)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.filePath).getRawString():""}getMotionSoundFileName(t,e){return this.isExistMotionSoundFile(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.soundPath).getRawString():""}getMotionFadeInTimeValue(t,e){return this.isExistMotionFadeIn(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.fadeInTime).toFloat():-1}getMotionFadeOutTimeValue(t,e){return this.isExistMotionFadeOut(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.fadeOutTime).toFloat():-1}getUserDataFile(){return this.isExistUserDataFile()?this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.userData).getRawString():""}getLayoutMap(t){const e=this.getJson().getRoot().getValueByString(this.layout).getMap();if(e==null)return!1;let i=!1;for(const s=e.begin();s.notEqual(e.end());s.preIncrement())t.setValue(s.ptr().first,s.ptr().second.toFloat()),i=!0;return i}getEyeBlinkParameterCount(){if(!this.isExistEyeBlinkParameters())return 0;let t=0;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.eyeBlink){t=i.getValueByString(this.ids).getVector().getSize();break}}return t}getEyeBlinkParameterId(t){if(!this.isExistEyeBlinkParameters())return null;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.eyeBlink)return I.getIdManager().getId(i.getValueByString(this.ids).getValueByIndex(t).getRawString())}return null}getLipSyncParameterCount(){if(!this.isExistLipSyncParameters())return 0;let t=0;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.lipSync){t=i.getValueByString(this.ids).getVector().getSize();break}}return t}getLipSyncParameterId(t){if(!this.isExistLipSyncParameters())return null;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.lipSync)return I.getIdManager().getId(i.getValueByString(this.ids).getValueByIndex(t).getRawString())}return null}isExistModelFile(){const t=this._jsonValue.at(1);return!t.isNull()&&!t.isError()}isExistTextureFiles(){const t=this._jsonValue.at(4);return!t.isNull()&&!t.isError()}isExistHitAreas(){const t=this._jsonValue.at(7);return!t.isNull()&&!t.isError()}isExistPhysicsFile(){const t=this._jsonValue.at(5);return!t.isNull()&&!t.isError()}isExistPoseFile(){const t=this._jsonValue.at(6);return!t.isNull()&&!t.isError()}isExistExpressionFile(){const t=this._jsonValue.at(3);return!t.isNull()&&!t.isError()}isExistMotionGroups(){const t=this._jsonValue.at(2);return!t.isNull()&&!t.isError()}isExistMotionGroupName(t){const e=this._jsonValue.at(2).getValueByString(t);return!e.isNull()&&!e.isError()}isExistMotionSoundFile(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.soundPath);return!i.isNull()&&!i.isError()}isExistMotionFadeIn(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.fadeInTime);return!i.isNull()&&!i.isError()}isExistMotionFadeOut(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(this.fadeOutTime);return!i.isNull()&&!i.isError()}isExistUserDataFile(){const t=this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.userData);return!t.isNull()&&!t.isError()}isExistEyeBlinkParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let t=0;t<this._jsonValue.at(0).getSize();++t)if(this._jsonValue.at(0).getValueByIndex(t).getValueByString(this.name).getRawString()==this.eyeBlink)return!0;return!1}isExistLipSyncParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let t=0;t<this._jsonValue.at(0).getSize();++t)if(this._jsonValue.at(0).getValueByIndex(t).getValueByString(this.name).getRawString()==this.lipSync)return!0;return!1}};var de;(r=>{r.CubismModelSettingJson=Is,r.FrequestNode=ki})(de||(de={}));class $t{static create(){return new $t}static delete(t){}setParameters(t){this._breathParameters=t}getParameters(){return this._breathParameters}updateParameters(t,e){this._currentTime+=e;const i=this._currentTime*2*Math.PI;for(let s=0;s<this._breathParameters.getSize();++s){const a=this._breathParameters.at(s);t.addParameterValueById(a.parameterId,a.offset+a.peak*Math.sin(i/a.cycle),a.weight)}}constructor(){this._currentTime=0}}class Fs{constructor(t,e,i,s,a){this.parameterId=t??null,this.offset=e??0,this.peak=i??0,this.cycle=s??0,this.weight=a??0}}var ze;(r=>{r.BreathParameterData=Fs,r.CubismBreath=$t})(ze||(ze={}));var st;let Ui=(st=class{static create(t=null){return new st(t)}static delete(t){}setBlinkingInterval(t){this._blinkingIntervalSeconds=t}setBlinkingSetting(t,e,i){this._closingSeconds=t,this._closedSeconds=e,this._openingSeconds=i}setParameterIds(t){this._parameterIds=t}getParameterIds(){return this._parameterIds}updateParameters(t,e){this._userTimeSeconds+=e;let i,s=0;switch(this._blinkingState){case 2:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds,s>=1&&(s=1,this._blinkingState=3,this._stateStartTimeSeconds=this._userTimeSeconds),i=1-s;break;case 3:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds,s>=1&&(this._blinkingState=4,this._stateStartTimeSeconds=this._userTimeSeconds),i=0;break;case 4:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds,s>=1&&(s=1,this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming()),i=s;break;case 1:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=2,this._stateStartTimeSeconds=this._userTimeSeconds),i=1;break;case 0:default:this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming(),i=1;break}st.CloseIfZero||(i=-i);for(let n=0;n<this._parameterIds.getSize();++n)t.setParameterValueById(this._parameterIds.at(n),i)}constructor(t){if(this._blinkingState=0,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=new x,t!=null)for(let e=0;e<t.getEyeBlinkParameterCount();++e)this._parameterIds.pushBack(t.getEyeBlinkParameterId(e))}determinNextBlinkingTiming(){const t=Math.random();return this._userTimeSeconds+t*(2*this._blinkingIntervalSeconds-1)}},st.CloseIfZero=!0,st);var Ni=(r=>(r[r.EyeState_First=0]="EyeState_First",r[r.EyeState_Interval=1]="EyeState_Interval",r[r.EyeState_Closing=2]="EyeState_Closing",r[r.EyeState_Closed=3]="EyeState_Closed",r[r.EyeState_Opening=4]="EyeState_Opening",r))(Ni||{}),_e;(r=>{r.CubismEyeBlink=Ui,r.EyeState=Ni})(_e||(_e={}));const ws=.001,Qt=.5,je="FadeInTime",Xe="Link",Ts="Groups",Rs="Id";class Tt{static create(t,e){const i=D.create(t,e);if(!i)return null;const s=new Tt,a=i.getRoot();a.getValueByString(je).isNull()||(s._fadeTimeSeconds=a.getValueByString(je).toFloat(Qt),s._fadeTimeSeconds<0&&(s._fadeTimeSeconds=Qt));const n=a.getValueByString(Ts),o=n.getSize();for(let l=0;l<o;++l){const u=n.getValueByIndex(l),h=u.getSize();let g=0;for(let m=0;m<h;++m){const c=u.getValueByIndex(m),d=new Rt,p=I.getIdManager().getId(c.getValueByString(Rs).getRawString());if(d.partId=p,!c.getValueByString(Xe).isNull()){const _=c.getValueByString(Xe),S=_.getSize();for(let b=0;b<S;++b){const f=new Rt,y=I.getIdManager().getId(_.getValueByIndex(b).getString());f.partId=y,d.link.pushBack(f)}}s._partGroups.pushBack(d.clone()),++g}s._partGroupCounts.pushBack(g)}return D.delete(i),s}static delete(t){}updateParameters(t,e){t!=this._lastModel&&this.reset(t),this._lastModel=t,e<0&&(e=0);let i=0;for(let s=0;s<this._partGroupCounts.getSize();s++){const a=this._partGroupCounts.at(s);this.doFade(t,e,i,a),i+=a}this.copyPartOpacities(t)}reset(t){let e=0;for(let i=0;i<this._partGroupCounts.getSize();++i){const s=this._partGroupCounts.at(i);for(let a=e;a<e+s;++a){this._partGroups.at(a).initialize(t);const n=this._partGroups.at(a).partIndex,o=this._partGroups.at(a).parameterIndex;if(!(n<0)){t.setPartOpacityByIndex(n,a==e?1:0),t.setParameterValueByIndex(o,a==e?1:0);for(let l=0;l<this._partGroups.at(a).link.getSize();++l)this._partGroups.at(a).link.at(l).initialize(t)}}e+=s}}copyPartOpacities(t){for(let e=0;e<this._partGroups.getSize();++e){const i=this._partGroups.at(e);if(i.link.getSize()==0)continue;const s=this._partGroups.at(e).partIndex,a=t.getPartOpacityByIndex(s);for(let n=0;n<i.link.getSize();++n){const l=i.link.at(n).partIndex;l<0||t.setPartOpacityByIndex(l,a)}}}doFade(t,e,i,s){let a=-1,n=1;const o=.5,l=.15;for(let u=i;u<i+s;++u){const h=this._partGroups.at(u).partIndex,g=this._partGroups.at(u).parameterIndex;if(t.getParameterValueByIndex(g)>ws){if(a>=0)break;if(a=u,this._fadeTimeSeconds==0){n=1;continue}n=t.getPartOpacityByIndex(h),n+=e/this._fadeTimeSeconds,n>1&&(n=1)}}a<0&&(a=0,n=1);for(let u=i;u<i+s;++u){const h=this._partGroups.at(u).partIndex;if(a==u)t.setPartOpacityByIndex(h,n);else{let g=t.getPartOpacityByIndex(h),m;n<o?m=n*(o-1)/o+1:m=(1-n)*o/(1-o),(1-m)*(1-n)>l&&(m=1-l/(1-n)),g>m&&(g=m),t.setPartOpacityByIndex(h,g)}}}constructor(){this._fadeTimeSeconds=Qt,this._lastModel=null,this._partGroups=new x,this._partGroupCounts=new x}}class Rt{constructor(t){if(this.parameterIndex=0,this.partIndex=0,this.link=new x,t!=null){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone())}}assignment(t){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone());return this}initialize(t){this.parameterIndex=t.getParameterIndex(this.partId),this.partIndex=t.getPartIndex(this.partId),t.setParameterValueByIndex(this.parameterIndex,1)}clone(){const t=new Rt;t.partId=this.partId,t.parameterIndex=this.parameterIndex,t.partIndex=this.partIndex,t.link=new x;for(let e=this.link.begin();e.notEqual(this.link.end());e.increment())t.link.pushBack(e.ptr().clone());return t}}var Ge;(r=>{r.CubismPose=Tt,r.PartData=Rt})(Ge||(Ge={}));class zi extends et{constructor(t,e){super(),this._width=t!==void 0?t:0,this._height=e!==void 0?e:0,this.setHeight(2)}setWidth(t){const e=t/this._width,i=e;this.scale(e,i)}setHeight(t){const e=t/this._height,i=e;this.scale(e,i)}setPosition(t,e){this.translate(t,e)}setCenterPosition(t,e){this.centerX(t),this.centerY(e)}top(t){this.setY(t)}bottom(t){const e=this._height*this.getScaleY();this.translateY(t-e)}left(t){this.setX(t)}right(t){const e=this._width*this.getScaleX();this.translateX(t-e)}centerX(t){const e=this._width*this.getScaleX();this.translateX(t-e/2)}setX(t){this.translateX(t)}centerY(t){const e=this._height*this.getScaleY();this.translateY(t-e/2)}setY(t){this.translateY(t)}setupFromLayout(t){const e="width",i="height",n="center_x",o="center_y",u="bottom",h="left",g="right";for(const m=t.begin();m.notEqual(t.end());m.preIncrement()){const c=m.ptr().first,d=m.ptr().second;c==e?this.setWidth(d):c==i&&this.setHeight(d)}for(const m=t.begin();m.notEqual(t.end());m.preIncrement()){const c=m.ptr().first,d=m.ptr().second;c=="x"?this.setX(d):c=="y"?this.setY(d):c==n?this.centerX(d):c==o?this.centerY(d):c=="top"?this.top(d):c==u?this.bottom(d):c==h?this.left(d):c==g&&this.right(d)}}}var Ye;(r=>{r.CubismModelMatrix=zi})(Ye||(Ye={}));class C{constructor(t,e){this.x=t,this.y=e,this.x=t??0,this.y=e??0}add(t){const e=new C(0,0);return e.x=this.x+t.x,e.y=this.y+t.y,e}substract(t){const e=new C(0,0);return e.x=this.x-t.x,e.y=this.y-t.y,e}multiply(t){const e=new C(0,0);return e.x=this.x*t.x,e.y=this.y*t.y,e}multiplyByScaler(t){return this.multiply(new C(t,t))}division(t){const e=new C(0,0);return e.x=this.x/t.x,e.y=this.y/t.y,e}divisionByScalar(t){return this.division(new C(t,t))}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}getDistanceWith(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))}dot(t){return this.x*t.x+this.y*t.y}normalize(){const t=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/t,this.y=this.y/t}isEqual(t){return this.x==t.x&&this.y==t.y}isNotEqual(t){return!this.isEqual(t)}}var We;(r=>{r.CubismVector2=C})(We||(We={}));const ft=class ft{static range(t,e,i){return t<e?t=e:t>i&&(t=i),t}static sin(t){return Math.sin(t)}static cos(t){return Math.cos(t)}static abs(t){return Math.abs(t)}static sqrt(t){return Math.sqrt(t)}static cbrt(t){if(t===0)return t;let e=t;const i=e<0;i&&(e=-e);let s;return e===1/0?s=1/0:(s=Math.exp(Math.log(e)/3),s=(e/(s*s)+2*s)/3),i?-s:s}static getEasingSine(t){return t<0?0:t>1?1:.5-.5*this.cos(t*Math.PI)}static max(t,e){return t>e?t:e}static min(t,e){return t>e?e:t}static clamp(t,e,i){return t<e?e:i<t?i:t}static degreesToRadian(t){return t/180*Math.PI}static radianToDegrees(t){return t*180/Math.PI}static directionToRadian(t,e){const i=Math.atan2(e.y,e.x),s=Math.atan2(t.y,t.x);let a=i-s;for(;a<-Math.PI;)a+=Math.PI*2;for(;a>Math.PI;)a-=Math.PI*2;return a}static directionToDegrees(t,e){const i=this.directionToRadian(t,e);let s=this.radianToDegrees(i);return e.x-t.x>0&&(s=-s),s}static radianToDirection(t){const e=new C;return e.x=this.sin(t),e.y=this.cos(t),e}static quadraticEquation(t,e,i){return this.abs(t)<ft.Epsilon?this.abs(e)<ft.Epsilon?-i:-i/e:-(e+this.sqrt(e*e-4*t*i))/(2*t)}static cardanoAlgorithmForBezier(t,e,i,s){if(this.abs(t)<ft.Epsilon)return this.range(this.quadraticEquation(e,i,s),0,1);const a=e/t,n=i/t,o=s/t,l=(3*n-a*a)/3,u=l/3,h=(2*a*a*a-9*a*n+27*o)/27,g=h/2,m=g*g+u*u*u,c=.5,d=c+.01;if(m<0){const f=-l/3,y=f*f*f,P=this.sqrt(y),v=-h/(2*P),T=this.range(v,-1,1),G=Math.acos(T),R=2*this.cbrt(P),Mt=R*this.cos(G/3)-a/3;if(this.abs(Mt-c)<d)return this.range(Mt,0,1);const Te=R*this.cos((G+2*Math.PI)/3)-a/3;if(this.abs(Te-c)<d)return this.range(Te,0,1);const bs=R*this.cos((G+4*Math.PI)/3)-a/3;return this.range(bs,0,1)}if(m==0){let f;g<0?f=this.cbrt(-g):f=-this.cbrt(g);const y=2*f-a/3;if(this.abs(y-c)<d)return this.range(y,0,1);const P=-f-a/3;return this.range(P,0,1)}const p=this.sqrt(m),_=this.cbrt(p-g),S=this.cbrt(p+g),b=_-S-a/3;return this.range(b,0,1)}static mod(t,e){if(!isFinite(t)||e===0||isNaN(t)||isNaN(e))return console.warn(`divided: ${t}, divisor: ${e} mod() returns 'NaN'.`),NaN;const i=Math.abs(t),s=Math.abs(e);let a=i-Math.floor(i/s)*s;return a*=Math.sign(t),a}constructor(){}};ft.Epsilon=1e-5;let M=ft;var qe;(r=>{r.CubismMath=M})(qe||(qe={}));const te=30,He=.01;class ji{constructor(){this._faceTargetX=0,this._faceTargetY=0,this._faceX=0,this._faceY=0,this._faceVX=0,this._faceVY=0,this._lastTimeSeconds=0,this._userTimeSeconds=0}update(t){this._userTimeSeconds+=t;const i=40/10*1/te;if(this._lastTimeSeconds==0){this._lastTimeSeconds=this._userTimeSeconds;return}const s=(this._userTimeSeconds-this._lastTimeSeconds)*te;this._lastTimeSeconds=this._userTimeSeconds;const n=.15*te,o=s*i/n,l=this._faceTargetX-this._faceX,u=this._faceTargetY-this._faceY;if(M.abs(l)<=He&&M.abs(u)<=He)return;const h=M.sqrt(l*l+u*u),g=i*l/h,m=i*u/h;let c=g-this._faceVX,d=m-this._faceVY;const p=M.sqrt(c*c+d*d);(p<-o||p>o)&&(c*=o/p,d*=o/p),this._faceVX+=c,this._faceVY+=d;{const _=.5*(M.sqrt(o*o+16*o*h-8*o*h)-o),S=M.sqrt(this._faceVX*this._faceVX+this._faceVY*this._faceVY);S>_&&(this._faceVX*=_/S,this._faceVY*=_/S)}this._faceX+=this._faceVX,this._faceY+=this._faceVY}getX(){return this._faceX}getY(){return this._faceY}set(t,e){this._faceTargetX=t,this._faceTargetY=e}}var Je;(r=>{r.CubismTargetPoint=ji})(Je||(Je={}));let Kt=class{constructor(){this.setBeganMotionHandler=t=>this._onBeganMotion=t,this.getBeganMotionHandler=()=>this._onBeganMotion,this.setFinishedMotionHandler=t=>this._onFinishedMotion=t,this.getFinishedMotionHandler=()=>this._onFinishedMotion,this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._isLoop=!1,this._isLoopFadeIn=!0,this._previousLoopState=this._isLoop,this._firedEventValues=new x}static delete(t){t.release(),t=null}release(){this._weight=0}updateParameters(t,e,i){if(!e.isAvailable()||e.isFinished())return;this.setupMotionQueueEntry(e,i);const s=this.updateFadeWeight(e,i);this.doUpdateParameters(t,i,s,e),e.getEndTime()>0&&e.getEndTime()<i&&e.setIsFinished(!0)}setupMotionQueueEntry(t,e){t==null||t.isStarted()||t.isAvailable()&&(t.setIsStarted(!0),t.setStartTime(e-this._offsetSeconds),t.setFadeInStartTime(e),t.getEndTime()<0&&this.adjustEndTime(t),t._motion._onBeganMotion&&t._motion._onBeganMotion(t._motion))}updateFadeWeight(t,e){t==null&&ve.print(mt.LogLevel_Error,"motionQueueEntry is null.");let i=this._weight;const s=this._fadeInSeconds==0?1:M.getEasingSine((e-t.getFadeInStartTime())/this._fadeInSeconds),a=this._fadeOutSeconds==0||t.getEndTime()<0?1:M.getEasingSine((t.getEndTime()-e)/this._fadeOutSeconds);return i=i*s*a,t.setState(e,i),A(0<=i&&i<=1),i}setFadeInTime(t){this._fadeInSeconds=t}setFadeOutTime(t){this._fadeOutSeconds=t}getFadeOutTime(){return this._fadeOutSeconds}getFadeInTime(){return this._fadeInSeconds}setWeight(t){this._weight=t}getWeight(){return this._weight}getDuration(){return-1}getLoopDuration(){return-1}setOffsetTime(t){this._offsetSeconds=t}setLoop(t){this._isLoop=t}getLoop(){return this._isLoop}setLoopFadeIn(t){this._isLoopFadeIn=t}getLoopFadeIn(){return this._isLoopFadeIn}getFiredEvent(t,e){return this._firedEventValues}isExistModelOpacity(){return!1}getModelOpacityIndex(){return-1}getModelOpacityId(t){return null}getModelOpacityValue(){return 1}adjustEndTime(t){const e=this.getDuration(),i=e<=0?-1:t.getStartTime()+e;t.setEndTime(i)}};var me;(r=>{r.ACubismMotion=Kt})(me||(me={}));const Es="FadeInTime",Ds="FadeOutTime",$e="Parameters",Ls="Id",Os="Value",Ot="Blend",As="Add",ks="Multiply",Us="Overwrite",Ke=1;var L;let pt=(L=class extends Kt{static create(t,e){const i=new L;return i.parse(t,e),i}doUpdateParameters(t,e,i,s){for(let a=0;a<this._parameters.getSize();++a){const n=this._parameters.at(a);switch(n.blendType){case 0:{t.addParameterValueById(n.parameterId,n.value,i);break}case 1:{t.multiplyParameterValueById(n.parameterId,n.value,i);break}case 2:{t.setParameterValueById(n.parameterId,n.value,i);break}}}}calculateExpressionParameters(t,e,i,s,a,n){if(!(i==null||s==null)&&i.isAvailable()){this._fadeWeight=this.updateFadeWeight(i,e);for(let o=0;o<s.getSize();++o){const l=s.at(o);if(l.parameterId==null)continue;const u=l.overwriteValue=t.getParameterValueById(l.parameterId),h=this.getExpressionParameters();let g=-1;for(let _=0;_<h.getSize();++_)if(l.parameterId==h.at(_).parameterId){g=_;break}if(g<0){a==0?(l.additiveValue=L.DefaultAdditiveValue,l.multiplyValue=L.DefaultMultiplyValue,l.overwriteValue=u):(l.additiveValue=this.calculateValue(l.additiveValue,L.DefaultAdditiveValue,n),l.multiplyValue=this.calculateValue(l.multiplyValue,L.DefaultMultiplyValue,n),l.overwriteValue=this.calculateValue(l.overwriteValue,u,n));continue}const m=h.at(g).value;let c,d,p;switch(h.at(g).blendType){case 0:c=m,d=L.DefaultMultiplyValue,p=u;break;case 1:c=L.DefaultAdditiveValue,d=m,p=u;break;case 2:c=L.DefaultAdditiveValue,d=L.DefaultMultiplyValue,p=m;break;default:return}a==0?(l.additiveValue=c,l.multiplyValue=d,l.overwriteValue=p):(l.additiveValue=l.additiveValue*(1-n)+c*n,l.multiplyValue=l.multiplyValue*(1-n)+d*n,l.overwriteValue=l.overwriteValue*(1-n)+p*n)}}}getExpressionParameters(){return this._parameters}getFadeWeight(){return this._fadeWeight}parse(t,e){const i=D.create(t,e);if(!i)return;const s=i.getRoot();this.setFadeInTime(s.getValueByString(Es).toFloat(Ke)),this.setFadeOutTime(s.getValueByString(Ds).toFloat(Ke));const a=s.getValueByString($e).getSize();this._parameters.prepareCapacity(a);for(let n=0;n<a;++n){const o=s.getValueByString($e).getValueByIndex(n),l=I.getIdManager().getId(o.getValueByString(Ls).getRawString()),u=o.getValueByString(Os).toFloat();let h;o.getValueByString(Ot).isNull()||o.getValueByString(Ot).getString()==As?h=0:o.getValueByString(Ot).getString()==ks?h=1:o.getValueByString(Ot).getString()==Us?h=2:h=0;const g=new Gi;g.parameterId=l,g.blendType=h,g.value=u,this._parameters.pushBack(g)}D.delete(i)}calculateValue(t,e,i){return t*(1-i)+e*i}constructor(){super(),this._parameters=new x,this._fadeWeight=0}},L.DefaultAdditiveValue=0,L.DefaultMultiplyValue=1,L);var Xi=(r=>(r[r.Additive=0]="Additive",r[r.Multiply=1]="Multiply",r[r.Overwrite=2]="Overwrite",r))(Xi||{});class Gi{}var pe;(r=>{r.CubismExpressionMotion=pt,r.ExpressionBlendType=Xi,r.ExpressionParameter=Gi})(pe||(pe={}));class Yi{constructor(){this._autoDelete=!1,this._motion=null,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}release(){this._autoDelete&&this._motion&&Kt.delete(this._motion)}setFadeOut(t){this._fadeOutSeconds=t,this._isTriggeredFadeOut=!0}startFadeOut(t,e){const i=e+t;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||i<this._endTimeSeconds)&&(this._endTimeSeconds=i)}isFinished(){return this._finished}isStarted(){return this._started}getStartTime(){return this._startTimeSeconds}getFadeInStartTime(){return this._fadeInStartTimeSeconds}getEndTime(){return this._endTimeSeconds}setStartTime(t){this._startTimeSeconds=t}setFadeInStartTime(t){this._fadeInStartTimeSeconds=t}setEndTime(t){this._endTimeSeconds=t}setIsFinished(t){this._finished=t}setIsStarted(t){this._started=t}isAvailable(){return this._available}setIsAvailable(t){this._available=t}setState(t,e){this._stateTimeSeconds=t,this._stateWeight=e}getStateTime(){return this._stateTimeSeconds}getStateWeight(){return this._stateWeight}getLastCheckEventSeconds(){return this._lastEventCheckSeconds}setLastCheckEventSeconds(t){this._lastEventCheckSeconds=t}isTriggeredFadeOut(){return this._isTriggeredFadeOut}getFadeOutSeconds(){return this._fadeOutSeconds}getCubismMotion(){return this._motion}}var Ze;(r=>{r.CubismMotionQueueEntry=Yi})(Ze||(Ze={}));class Ve{constructor(){this._userTimeSeconds=0,this._eventCallBack=null,this._eventCustomData=null,this._motions=new x}release(){for(let t=0;t<this._motions.getSize();++t)this._motions.at(t)&&(this._motions.at(t).release(),this._motions.set(t,null));this._motions=null}startMotion(t,e,i){if(t==null)return Wi;let s=null;for(let a=0;a<this._motions.getSize();++a)s=this._motions.at(a),s?.setFadeOut(s._motion.getFadeOutTime());return s=new Yi,s._autoDelete=e,s._motion=t,this._motions.pushBack(s),s._motionQueueEntryHandle}isFinished(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}if(e._motion==null){e.release(),e=null,t=this._motions.erase(t);continue}if(e.isFinished())t.preIncrement();else return!1}return!0}isFinishedByHandle(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.increment()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t&&!i.isFinished())return!1}return!0}stopAllMotions(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}e.release(),e=null,t=this._motions.erase(t)}}getCubismMotionQueueEntries(){return this._motions}getCubismMotionQueueEntry(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.preIncrement()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t)return i}return null}setEventCallback(t,e=null){this._eventCallBack=t,this._eventCustomData=e}doUpdateMotion(t,e){let i=!1;for(let s=this._motions.begin();s.notEqual(this._motions.end());){let a=s.ptr();if(a==null){s=this._motions.erase(s);continue}const n=a._motion;if(n==null){a.release(),a=null,s=this._motions.erase(s);continue}n.updateParameters(t,a,e),i=!0;const o=n.getFiredEvent(a.getLastCheckEventSeconds()-a.getStartTime(),e-a.getStartTime());for(let l=0;l<o.getSize();++l)this._eventCallBack(this,o.at(l),this._eventCustomData);a.setLastCheckEventSeconds(e),a.isFinished()?(a.release(),a=null,s=this._motions.erase(s)):(a.isTriggeredFadeOut()&&a.startFadeOut(a.getFadeOutSeconds(),e),s.preIncrement())}return i}}const Wi=-1;var Qe;(r=>{r.CubismMotionQueueManager=Ve,r.InvalidMotionQueueEntryHandleValue=Wi})(Qe||(Qe={}));class Ns{}class qi extends Ve{constructor(){super(),this._currentPriority=0,this._reservePriority=0,this._expressionParameterValues=new x,this._fadeWeights=new x}release(){this._expressionParameterValues&&(_t(this._expressionParameterValues),this._expressionParameterValues=null),this._fadeWeights&&(_t(this._fadeWeights),this._fadeWeights=null)}getCurrentPriority(){return j("CubismExpressionMotionManager.getCurrentPriority() is deprecated because a priority value is not actually used during expression motion playback."),this._currentPriority}getReservePriority(){return j("CubismExpressionMotionManager.getReservePriority() is deprecated because a priority value is not actually used during expression motion playback."),this._reservePriority}getFadeWeight(t){return t<0||this._fadeWeights.getSize()<1||t>=this._fadeWeights.getSize()?(console.warn("Failed to get the fade weight value. The element at that index does not exist."),-1):this._fadeWeights.at(t)}setFadeWeight(t,e){if(t<0||this._fadeWeights.getSize()<1||this._fadeWeights.getSize()<=t){console.warn("Failed to set the fade weight value. The element at that index does not exist.");return}this._fadeWeights.set(t,e)}setReservePriority(t){j("CubismExpressionMotionManager.setReservePriority() is deprecated because a priority value is not actually used during expression motion playback."),this._reservePriority=t}startMotionPriority(t,e,i){return j("CubismExpressionMotionManager.startMotionPriority() is deprecated because a priority value is not actually used during expression motion playback."),i==this.getReservePriority()&&this.setReservePriority(0),this._currentPriority=i,this.startMotion(t,e)}updateMotion(t,e){this._userTimeSeconds+=e;let i=!1;const s=this.getCubismMotionQueueEntries();let a=0,n=0;if(this._fadeWeights.getSize()!==s.getSize()){const o=s.getSize()-this._fadeWeights.getSize();for(let l=0;l<o;l++)this._fadeWeights.pushBack(0)}for(let o=this._motions.begin();o.notEqual(this._motions.end());){const l=o.ptr();if(l==null){o=s.erase(o);continue}const u=l.getCubismMotion();if(u==null){_t(l),o=s.erase(o);continue}const h=u.getExpressionParameters();if(l.isAvailable())for(let g=0;g<h.getSize();++g){if(h.at(g).parameterId==null)continue;let m=-1;for(let d=0;d<this._expressionParameterValues.getSize();++d)if(this._expressionParameterValues.at(d).parameterId==h.at(g).parameterId){m=d;break}if(m>=0)continue;const c=new Ns;c.parameterId=h.at(g).parameterId,c.additiveValue=pt.DefaultAdditiveValue,c.multiplyValue=pt.DefaultMultiplyValue,c.overwriteValue=t.getParameterValueById(c.parameterId),this._expressionParameterValues.pushBack(c)}u.setupMotionQueueEntry(l,this._userTimeSeconds),this.setFadeWeight(n,u.updateFadeWeight(l,this._userTimeSeconds)),u.calculateExpressionParameters(t,this._userTimeSeconds,l,this._expressionParameterValues,n,this.getFadeWeight(n)),a+=u.getFadeInTime()==0?1:M.getEasingSine((this._userTimeSeconds-l.getFadeInStartTime())/u.getFadeInTime()),i=!0,l.isTriggeredFadeOut()&&l.startFadeOut(l.getFadeOutSeconds(),this._userTimeSeconds),o.preIncrement(),++n}if(s.getSize()>1&&this.getFadeWeight(this._fadeWeights.getSize()-1)>=1)for(let l=s.getSize()-2;l>=0;--l){const u=s.at(l);_t(u),s.remove(l),this._fadeWeights.remove(l)}a>1&&(a=1);for(let o=0;o<this._expressionParameterValues.getSize();++o){const l=this._expressionParameterValues.at(o);t.setParameterValueById(l.parameterId,(l.overwriteValue+l.additiveValue)*l.multiplyValue,a),l.additiveValue=pt.DefaultAdditiveValue,l.multiplyValue=pt.DefaultMultiplyValue}return i}}var ti;(r=>{r.CubismExpressionMotionManager=qi})(ti||(ti={}));var W=(r=>(r[r.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",r[r.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",r[r.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity",r))(W||{}),E=(r=>(r[r.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",r[r.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",r[r.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",r[r.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped",r))(E||{});class Et{constructor(){this.time=0,this.value=0}}class Hi{constructor(){this.evaluate=null,this.basePointIndex=0,this.segmentType=0}}class Ji{constructor(){this.type=0,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0}}class $i{constructor(){this.fireTime=0}}class Ki{constructor(){this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=new x,this.segments=new x,this.points=new x,this.events=new x}}var ei;(r=>{r.CubismMotionCurve=Ji,r.CubismMotionCurveTarget=W,r.CubismMotionData=Ki,r.CubismMotionEvent=$i,r.CubismMotionPoint=Et,r.CubismMotionSegment=Hi,r.CubismMotionSegmentType=E})(ei||(ei={}));const U="Meta",zs="Duration",js="Loop",Xs="AreBeziersRestricted",Gs="CurveCount",Ys="Fps",Ws="TotalSegmentCount",qs="TotalPointCount",$="Curves",Hs="Target",Js="Id",At="FadeInTime",kt="FadeOutTime",ii="Segments",si="UserData",$s="UserDataCount",Ks="TotalUserDataSize",Zs="Time",Qs="Value";class Zi{constructor(t,e){this._json=D.create(t,e)}release(){D.delete(this._json)}getMotionDuration(){return this._json.getRoot().getValueByString(U).getValueByString(zs).toFloat()}isMotionLoop(){return this._json.getRoot().getValueByString(U).getValueByString(js).toBoolean()}hasConsistency(){let t=!0;if(!this._json||!this._json.getRoot())return!1;const e=this._json.getRoot().getValueByString($).getVector().getSize();let i=0,s=0;for(let a=0;a<e;++a)for(let n=0;n<this.getMotionCurveSegmentCount(a);){switch(n==0&&(s+=1,n+=2),this.getMotionCurveSegment(a,n)){case E.CubismMotionSegmentType_Linear:s+=1,n+=3;break;case E.CubismMotionSegmentType_Bezier:s+=3,n+=7;break;case E.CubismMotionSegmentType_Stepped:s+=1,n+=3;break;case E.CubismMotionSegmentType_InverseStepped:s+=1,n+=3;break;default:A(0);break}++i}return e!=this.getMotionCurveCount()&&(B("The number of curves does not match the metadata."),t=!1),i!=this.getMotionTotalSegmentCount()&&(B("The number of segment does not match the metadata."),t=!1),s!=this.getMotionTotalPointCount()&&(B("The number of point does not match the metadata."),t=!1),t}getEvaluationOptionFlag(t){return t==0?this._json.getRoot().getValueByString(U).getValueByString(Xs).toBoolean():!1}getMotionCurveCount(){return this._json.getRoot().getValueByString(U).getValueByString(Gs).toInt()}getMotionFps(){return this._json.getRoot().getValueByString(U).getValueByString(Ys).toFloat()}getMotionTotalSegmentCount(){return this._json.getRoot().getValueByString(U).getValueByString(Ws).toInt()}getMotionTotalPointCount(){return this._json.getRoot().getValueByString(U).getValueByString(qs).toInt()}isExistMotionFadeInTime(){return!this._json.getRoot().getValueByString(U).getValueByString(At).isNull()}isExistMotionFadeOutTime(){return!this._json.getRoot().getValueByString(U).getValueByString(kt).isNull()}getMotionFadeInTime(){return this._json.getRoot().getValueByString(U).getValueByString(At).toFloat()}getMotionFadeOutTime(){return this._json.getRoot().getValueByString(U).getValueByString(kt).toFloat()}getMotionCurveTarget(t){return this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(Hs).getRawString()}getMotionCurveId(t){return I.getIdManager().getId(this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(Js).getRawString())}isExistMotionCurveFadeInTime(t){return!this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(At).isNull()}isExistMotionCurveFadeOutTime(t){return!this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(kt).isNull()}getMotionCurveFadeInTime(t){return this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(At).toFloat()}getMotionCurveFadeOutTime(t){return this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(kt).toFloat()}getMotionCurveSegmentCount(t){return this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(ii).getVector().getSize()}getMotionCurveSegment(t,e){return this._json.getRoot().getValueByString($).getValueByIndex(t).getValueByString(ii).getValueByIndex(e).toFloat()}getEventCount(){return this._json.getRoot().getValueByString(U).getValueByString($s).toInt()}getTotalEventValueSize(){return this._json.getRoot().getValueByString(U).getValueByString(Ks).toInt()}getEventTime(t){return this._json.getRoot().getValueByString(si).getValueByIndex(t).getValueByString(Zs).toFloat()}getEventValue(t){return new X(this._json.getRoot().getValueByString(si).getValueByIndex(t).getValueByString(Qs).getRawString())}}var Qi=(r=>(r[r.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted",r))(Qi||{}),ri;(r=>{r.CubismMotionJson=Zi})(ri||(ri={}));const tr="EyeBlink",er="LipSync",ir="Model",sr="Parameter",rr="PartOpacity",Ut="Opacity",ar=!1;function z(r,t,e){const i=new Et;return i.time=r.time+(t.time-r.time)*e,i.value=r.value+(t.value-r.value)*e,i}function ts(r,t){let e=(t-r[0].time)/(r[1].time-r[0].time);return e<0&&(e=0),r[0].value+(r[1].value-r[0].value)*e}function nr(r,t){let e=(t-r[0].time)/(r[3].time-r[0].time);e<0&&(e=0);const i=z(r[0],r[1],e),s=z(r[1],r[2],e),a=z(r[2],r[3],e),n=z(i,s,e),o=z(s,a,e);return z(n,o,e).value}function or(r,t){const e=t,i=r[0].time,s=r[3].time,a=r[1].time,n=r[2].time,o=s-3*n+3*a-i,l=3*n-6*a+3*i,u=3*a-3*i,h=i-e,g=M.cardanoAlgorithmForBezier(o,l,u,h),m=z(r[0],r[1],g),c=z(r[1],r[2],g),d=z(r[2],r[3],g),p=z(m,c,g),_=z(c,d,g);return z(p,_,g).value}function es(r,t){return r[0].value}function is(r,t){return r[1].value}function ee(r,t,e,i,s){const a=r.curves.at(t);let n=-1;const o=a.baseSegmentIndex+a.segmentCount;let l=0;for(let h=a.baseSegmentIndex;h<o;++h)if(l=r.segments.at(h).basePointIndex+(r.segments.at(h).segmentType==E.CubismMotionSegmentType_Bezier?3:1),r.points.at(l).time>e){n=h;break}if(n==-1)return i&&e<s?lr(r,o-1,r.segments.at(a.baseSegmentIndex).basePointIndex,l,e,s):r.points.at(l).value;const u=r.segments.at(n);return u.evaluate(r.points.get(u.basePointIndex),e)}function lr(r,t,e,i,s,a){const n=[new Et,new Et];{const o=r.points.at(i);n[0].time=o.time,n[0].value=o.value}{const o=r.points.at(e);n[1].time=a,n[1].value=o.value}switch(r.segments.at(t).segmentType){case E.CubismMotionSegmentType_Linear:case E.CubismMotionSegmentType_Bezier:default:return ts(n,s);case E.CubismMotionSegmentType_Stepped:return es(n);case E.CubismMotionSegmentType_InverseStepped:return is(n)}}let ss=class rs extends Kt{constructor(){super(),this._motionBehavior=1,this._sourceFrameRate=30,this._loopDurationSeconds=-1,this._isLoop=!1,this._isLoopFadeIn=!0,this._lastWeight=0,this._motionData=null,this._modelCurveIdEyeBlink=null,this._modelCurveIdLipSync=null,this._modelCurveIdOpacity=null,this._eyeBlinkParameterIds=null,this._lipSyncParameterIds=null,this._modelOpacity=1,this._debugMode=!1}static create(t,e,i,s,a=!1){const n=new rs;if(n.parse(t,e,a),n._motionData)n._sourceFrameRate=n._motionData.fps,n._loopDurationSeconds=n._motionData.duration,n._onFinishedMotion=i,n._onBeganMotion=s;else return _t(n),null;return n}doUpdateParameters(t,e,i,s){this._modelCurveIdEyeBlink==null&&(this._modelCurveIdEyeBlink=I.getIdManager().getId(tr)),this._modelCurveIdLipSync==null&&(this._modelCurveIdLipSync=I.getIdManager().getId(er)),this._modelCurveIdOpacity==null&&(this._modelCurveIdOpacity=I.getIdManager().getId(Ut)),this._motionBehavior===1&&this._previousLoopState!==this._isLoop&&(this.adjustEndTime(s),this._previousLoopState=this._isLoop);let a=e-s.getStartTime();a<0&&(a=0);let n=Number.MAX_VALUE,o=Number.MAX_VALUE;const l=64;let u=0,h=0;this._eyeBlinkParameterIds.getSize()>l&&Ft("too many eye blink targets : {0}",this._eyeBlinkParameterIds.getSize()),this._lipSyncParameterIds.getSize()>l&&Ft("too many lip sync targets : {0}",this._lipSyncParameterIds.getSize());const g=this._fadeInSeconds<=0?1:M.getEasingSine((e-s.getFadeInStartTime())/this._fadeInSeconds),m=this._fadeOutSeconds<=0||s.getEndTime()<0?1:M.getEasingSine((s.getEndTime()-e)/this._fadeOutSeconds);let c,d,p,_=a,S=this._motionData.duration;const b=this._motionBehavior===1&&this._isLoop;if(this._isLoop)for(this._motionBehavior===1&&(S+=1/this._motionData.fps);_>S;)_-=S;const f=this._motionData.curves;for(d=0;d<this._motionData.curveCount&&f.at(d).type==W.CubismMotionCurveTarget_Model;++d)c=ee(this._motionData,d,_,b,S),f.at(d).id==this._modelCurveIdEyeBlink?o=c:f.at(d).id==this._modelCurveIdLipSync?n=c:f.at(d).id==this._modelCurveIdOpacity&&(this._modelOpacity=c,t.setModelOapcity(this.getModelOpacityValue()));for(;d<this._motionData.curveCount&&f.at(d).type==W.CubismMotionCurveTarget_Parameter;++d){if(p=t.getParameterIndex(f.at(d).id),p==-1)continue;const y=t.getParameterValueByIndex(p);if(c=ee(this._motionData,d,_,b,S),o!=Number.MAX_VALUE){for(let v=0;v<this._eyeBlinkParameterIds.getSize()&&v<l;++v)if(this._eyeBlinkParameterIds.at(v)==f.at(d).id){c*=o,h|=1<<v;break}}if(n!=Number.MAX_VALUE){for(let v=0;v<this._lipSyncParameterIds.getSize()&&v<l;++v)if(this._lipSyncParameterIds.at(v)==f.at(d).id){c+=n,u|=1<<v;break}}t.isRepeat(p)&&(c=t.getParameterRepeatValue(p,c));let P;if(f.at(d).fadeInTime<0&&f.at(d).fadeOutTime<0)P=y+(c-y)*i;else{let v,T;f.at(d).fadeInTime<0?v=g:v=f.at(d).fadeInTime==0?1:M.getEasingSine((e-s.getFadeInStartTime())/f.at(d).fadeInTime),f.at(d).fadeOutTime<0?T=m:T=f.at(d).fadeOutTime==0||s.getEndTime()<0?1:M.getEasingSine((s.getEndTime()-e)/f.at(d).fadeOutTime);const G=this._weight*v*T;P=y+(c-y)*G}t.setParameterValueByIndex(p,P,1)}{if(o!=Number.MAX_VALUE)for(let y=0;y<this._eyeBlinkParameterIds.getSize()&&y<l;++y){const P=t.getParameterValueById(this._eyeBlinkParameterIds.at(y));if(h>>y&1)continue;const v=P+(o-P)*i;t.setParameterValueById(this._eyeBlinkParameterIds.at(y),v)}if(n!=Number.MAX_VALUE)for(let y=0;y<this._lipSyncParameterIds.getSize()&&y<l;++y){const P=t.getParameterValueById(this._lipSyncParameterIds.at(y));if(u>>y&1)continue;const v=P+(n-P)*i;t.setParameterValueById(this._lipSyncParameterIds.at(y),v)}}for(;d<this._motionData.curveCount&&f.at(d).type==W.CubismMotionCurveTarget_PartOpacity;++d)p=t.getParameterIndex(f.at(d).id),p!=-1&&(c=ee(this._motionData,d,_,b,S),t.setParameterValueByIndex(p,c));a>=S&&(this._isLoop?this.updateForNextLoop(s,e,_):(this._onFinishedMotion&&this._onFinishedMotion(this),s.setIsFinished(!0))),this._lastWeight=i}setIsLoop(t){B("setIsLoop() is a deprecated function. Please use setLoop()."),this._isLoop=t}isLoop(){return B("isLoop() is a deprecated function. Please use getLoop()."),this._isLoop}setIsLoopFadeIn(t){B("setIsLoopFadeIn() is a deprecated function. Please use setLoopFadeIn()."),this._isLoopFadeIn=t}isLoopFadeIn(){return B("isLoopFadeIn() is a deprecated function. Please use getLoopFadeIn()."),this._isLoopFadeIn}setMotionBehavior(t){this._motionBehavior=t}getMotionBehavior(){return this._motionBehavior}getDuration(){return this._isLoop?-1:this._loopDurationSeconds}getLoopDuration(){return this._loopDurationSeconds}setParameterFadeInTime(t,e){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(t==i.at(s).id){i.at(s).fadeInTime=e;return}}setParameterFadeOutTime(t,e){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(t==i.at(s).id){i.at(s).fadeOutTime=e;return}}getParameterFadeInTime(t){const e=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(t==e.at(i).id)return e.at(i).fadeInTime;return-1}getParameterFadeOutTime(t){const e=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(t==e.at(i).id)return e.at(i).fadeOutTime;return-1}setEffectIds(t,e){this._eyeBlinkParameterIds=t,this._lipSyncParameterIds=e}release(){this._motionData=void 0,this._motionData=null}updateForNextLoop(t,e,i){switch(this._motionBehavior){case 1:default:t.setStartTime(e-i),this._isLoopFadeIn&&t.setFadeInStartTime(e-i),this._onFinishedMotion!=null&&this._onFinishedMotion(this);break;case 0:t.setStartTime(e),this._isLoopFadeIn&&t.setFadeInStartTime(e);break}}parse(t,e,i=!1){let s=new Zi(t,e);if(!s){s.release(),s=void 0;return}if(i&&!s.hasConsistency()){s.release(),w("Inconsistent motion3.json.");return}this._motionData=new Ki,this._motionData.duration=s.getMotionDuration(),this._motionData.loop=s.isMotionLoop(),this._motionData.curveCount=s.getMotionCurveCount(),this._motionData.fps=s.getMotionFps(),this._motionData.eventCount=s.getEventCount();const a=s.getEvaluationOptionFlag(Qi.EvaluationOptionFlag_AreBeziersRistricted);s.isExistMotionFadeInTime()?this._fadeInSeconds=s.getMotionFadeInTime()<0?1:s.getMotionFadeInTime():this._fadeInSeconds=1,s.isExistMotionFadeOutTime()?this._fadeOutSeconds=s.getMotionFadeOutTime()<0?1:s.getMotionFadeOutTime():this._fadeOutSeconds=1,this._motionData.curves.updateSize(this._motionData.curveCount,Ji,!0),this._motionData.segments.updateSize(s.getMotionTotalSegmentCount(),Hi,!0),this._motionData.points.updateSize(s.getMotionTotalPointCount(),Et,!0),this._motionData.events.updateSize(this._motionData.eventCount,$i,!0);let n=0,o=0;for(let l=0;l<this._motionData.curveCount;++l){s.getMotionCurveTarget(l)==ir?this._motionData.curves.at(l).type=W.CubismMotionCurveTarget_Model:s.getMotionCurveTarget(l)==sr?this._motionData.curves.at(l).type=W.CubismMotionCurveTarget_Parameter:s.getMotionCurveTarget(l)==rr?this._motionData.curves.at(l).type=W.CubismMotionCurveTarget_PartOpacity:B('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!'),this._motionData.curves.at(l).id=s.getMotionCurveId(l),this._motionData.curves.at(l).baseSegmentIndex=o,this._motionData.curves.at(l).fadeInTime=s.isExistMotionCurveFadeInTime(l)?s.getMotionCurveFadeInTime(l):-1,this._motionData.curves.at(l).fadeOutTime=s.isExistMotionCurveFadeOutTime(l)?s.getMotionCurveFadeOutTime(l):-1;for(let u=0;u<s.getMotionCurveSegmentCount(l);){switch(u==0?(this._motionData.segments.at(o).basePointIndex=n,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,u),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,u+1),n+=1,u+=2):this._motionData.segments.at(o).basePointIndex=n-1,s.getMotionCurveSegment(l,u)){case E.CubismMotionSegmentType_Linear:{this._motionData.segments.at(o).segmentType=E.CubismMotionSegmentType_Linear,this._motionData.segments.at(o).evaluate=ts,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,u+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,u+2),n+=1,u+=3;break}case E.CubismMotionSegmentType_Bezier:{this._motionData.segments.at(o).segmentType=E.CubismMotionSegmentType_Bezier,a||ar?this._motionData.segments.at(o).evaluate=nr:this._motionData.segments.at(o).evaluate=or,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,u+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,u+2),this._motionData.points.at(n+1).time=s.getMotionCurveSegment(l,u+3),this._motionData.points.at(n+1).value=s.getMotionCurveSegment(l,u+4),this._motionData.points.at(n+2).time=s.getMotionCurveSegment(l,u+5),this._motionData.points.at(n+2).value=s.getMotionCurveSegment(l,u+6),n+=3,u+=7;break}case E.CubismMotionSegmentType_Stepped:{this._motionData.segments.at(o).segmentType=E.CubismMotionSegmentType_Stepped,this._motionData.segments.at(o).evaluate=es,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,u+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,u+2),n+=1,u+=3;break}case E.CubismMotionSegmentType_InverseStepped:{this._motionData.segments.at(o).segmentType=E.CubismMotionSegmentType_InverseStepped,this._motionData.segments.at(o).evaluate=is,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,u+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,u+2),n+=1,u+=3;break}default:{A(0);break}}++this._motionData.curves.at(l).segmentCount,++o}}for(let l=0;l<s.getEventCount();++l)this._motionData.events.at(l).fireTime=s.getEventTime(l),this._motionData.events.at(l).value=s.getEventValue(l);s.release(),s=void 0,s=null}getFiredEvent(t,e){this._firedEventValues.updateSize(0);for(let i=0;i<this._motionData.eventCount;++i)this._motionData.events.at(i).fireTime>t&&this._motionData.events.at(i).fireTime<=e&&this._firedEventValues.pushBack(new X(this._motionData.events.at(i).value.s));return this._firedEventValues}isExistModelOpacity(){for(let t=0;t<this._motionData.curveCount;t++){const e=this._motionData.curves.at(t);if(e.type==W.CubismMotionCurveTarget_Model&&e.id.getString().s.localeCompare(Ut)==0)return!0}return!1}getModelOpacityIndex(){if(this.isExistModelOpacity())for(let t=0;t<this._motionData.curveCount;t++){const e=this._motionData.curves.at(t);if(e.type==W.CubismMotionCurveTarget_Model&&e.id.getString().s.localeCompare(Ut)==0)return t}return-1}getModelOpacityId(t){if(t!=-1){const e=this._motionData.curves.at(t);if(e.type==W.CubismMotionCurveTarget_Model&&e.id.getString().s.localeCompare(Ut)==0)return I.getIdManager().getId(e.id.getString().s)}return null}getModelOpacityValue(){return this._modelOpacity}setDebugMode(t){this._debugMode=t}};var fe;(r=>{r.CubismMotion=ss})(fe||(fe={}));let as=class extends Ve{constructor(){super(),this._currentPriority=0,this._reservePriority=0}getCurrentPriority(){return this._currentPriority}getReservePriority(){return this._reservePriority}setReservePriority(t){this._reservePriority=t}startMotionPriority(t,e,i){return i==this._reservePriority&&(this._reservePriority=0),this._currentPriority=i,super.startMotion(t,e)}updateMotion(t,e){this._userTimeSeconds+=e;const i=super.doUpdateMotion(t,this._userTimeSeconds);return this.isFinished()&&(this._currentPriority=0),i}reserveMotion(t){return t<=this._reservePriority||t<=this._currentPriority?!1:(this._reservePriority=t,!0)}};var ye;(r=>{r.CubismMotionManager=as})(ye||(ye={}));var qt=(r=>(r[r.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter",r))(qt||{}),Q=(r=>(r[r.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",r[r.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",r[r.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle",r))(Q||{});class ur{constructor(){this.gravity=new C(0,0),this.wind=new C(0,0)}}class Ie{}class Ce{}class ns{constructor(){this.initialPosition=new C(0,0),this.position=new C(0,0),this.lastPosition=new C(0,0),this.lastGravity=new C(0,0),this.force=new C(0,0),this.velocity=new C(0,0)}}class os{constructor(){this.normalizationPosition=new Ce,this.normalizationAngle=new Ce}}class ls{constructor(){this.source=new Ie}}class us{constructor(){this.destination=new Ie,this.translationScale=new C(0,0)}}class hs{constructor(){this.settings=new x,this.inputs=new x,this.outputs=new x,this.particles=new x,this.gravity=new C(0,0),this.wind=new C(0,0),this.fps=0}}var ai;(r=>{r.CubismPhysicsInput=ls,r.CubismPhysicsNormalization=Ce,r.CubismPhysicsOutput=us,r.CubismPhysicsParameter=Ie,r.CubismPhysicsParticle=ns,r.CubismPhysicsRig=hs,r.CubismPhysicsSource=Q,r.CubismPhysicsSubRig=os,r.CubismPhysicsTargetType=qt,r.PhysicsJsonEffectiveForces=ur})(ai||(ai={}));const Pt="Position",ie="X",se="Y",re="Angle",ni="Type",oi="Id",K="Meta",Nt="EffectiveForces",hr="TotalInputCount",gr="TotalOutputCount",cr="PhysicsSettingCount",li="Gravity",ui="Wind",dr="VertexCount",_r="Fps",F="PhysicsSettings",gt="Normalization",hi="Minimum",gi="Maximum",ci="Default",di="Reflect",_i="Weight",vt="Input",mr="Source",rt="Output",pr="Scale",fr="VertexIndex",yr="Destination",at="Vertices",Cr="Mobility",xr="Delay",Sr="Radius",Mr="Acceleration";class gs{constructor(t,e){this._json=D.create(t,e)}release(){D.delete(this._json)}getGravity(){const t=new C(0,0);return t.x=this._json.getRoot().getValueByString(K).getValueByString(Nt).getValueByString(li).getValueByString(ie).toFloat(),t.y=this._json.getRoot().getValueByString(K).getValueByString(Nt).getValueByString(li).getValueByString(se).toFloat(),t}getWind(){const t=new C(0,0);return t.x=this._json.getRoot().getValueByString(K).getValueByString(Nt).getValueByString(ui).getValueByString(ie).toFloat(),t.y=this._json.getRoot().getValueByString(K).getValueByString(Nt).getValueByString(ui).getValueByString(se).toFloat(),t}getFps(){return this._json.getRoot().getValueByString(K).getValueByString(_r).toFloat(0)}getSubRigCount(){return this._json.getRoot().getValueByString(K).getValueByString(cr).toInt()}getTotalInputCount(){return this._json.getRoot().getValueByString(K).getValueByString(hr).toInt()}getTotalOutputCount(){return this._json.getRoot().getValueByString(K).getValueByString(gr).toInt()}getVertexCount(){return this._json.getRoot().getValueByString(K).getValueByString(dr).toInt()}getNormalizationPositionMinimumValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(Pt).getValueByString(hi).toFloat()}getNormalizationPositionMaximumValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(Pt).getValueByString(gi).toFloat()}getNormalizationPositionDefaultValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(Pt).getValueByString(ci).toFloat()}getNormalizationAngleMinimumValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(re).getValueByString(hi).toFloat()}getNormalizationAngleMaximumValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(re).getValueByString(gi).toFloat()}getNormalizationAngleDefaultValue(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(gt).getValueByString(re).getValueByString(ci).toFloat()}getInputCount(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(vt).getVector().getSize()}getInputWeight(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(vt).getValueByIndex(e).getValueByString(_i).toFloat()}getInputReflect(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(vt).getValueByIndex(e).getValueByString(di).toBoolean()}getInputType(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(vt).getValueByIndex(e).getValueByString(ni).getRawString()}getInputSourceId(t,e){return I.getIdManager().getId(this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(vt).getValueByIndex(e).getValueByString(mr).getValueByString(oi).getRawString())}getOutputCount(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getVector().getSize()}getOutputVertexIndex(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(fr).toInt()}getOutputAngleScale(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(pr).toFloat()}getOutputWeight(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(_i).toFloat()}getOutputDestinationId(t,e){return I.getIdManager().getId(this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(yr).getValueByString(oi).getRawString())}getOutputType(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(ni).getRawString()}getOutputReflect(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(rt).getValueByIndex(e).getValueByString(di).toBoolean()}getParticleCount(t){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getVector().getSize()}getParticleMobility(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(Cr).toFloat()}getParticleDelay(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(xr).toFloat()}getParticleAcceleration(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(Mr).toFloat()}getParticleRadius(t,e){return this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(Sr).toFloat()}getParticlePosition(t,e){const i=new C(0,0);return i.x=this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(Pt).getValueByString(ie).toFloat(),i.y=this._json.getRoot().getValueByString(F).getValueByIndex(t).getValueByString(at).getValueByIndex(e).getValueByString(Pt).getValueByString(se).toFloat(),i}}var mi;(r=>{r.CubismPhysicsJson=gs})(mi||(mi={}));const pi="X",fi="Y",yi="Angle",br=5,xe=100,Ci=.001,Pr=5;let Se=class cs{static create(t,e){const i=new cs;return i.parse(t,e),i._physicsRig.gravity.y=0,i}static delete(t){t!=null&&(t.release(),t=null)}parse(t,e){this._physicsRig=new hs;let i=new gs(t,e);this._physicsRig.gravity=i.getGravity(),this._physicsRig.wind=i.getWind(),this._physicsRig.subRigCount=i.getSubRigCount(),this._physicsRig.fps=i.getFps(),this._physicsRig.settings.updateSize(this._physicsRig.subRigCount,os,!0),this._physicsRig.inputs.updateSize(i.getTotalInputCount(),ls,!0),this._physicsRig.outputs.updateSize(i.getTotalOutputCount(),us,!0),this._physicsRig.particles.updateSize(i.getVertexCount(),ns,!0),this._currentRigOutputs.clear(),this._previousRigOutputs.clear();let s=0,a=0,n=0;for(let o=0;o<this._physicsRig.settings.getSize();++o){this._physicsRig.settings.at(o).normalizationPosition.minimum=i.getNormalizationPositionMinimumValue(o),this._physicsRig.settings.at(o).normalizationPosition.maximum=i.getNormalizationPositionMaximumValue(o),this._physicsRig.settings.at(o).normalizationPosition.defalut=i.getNormalizationPositionDefaultValue(o),this._physicsRig.settings.at(o).normalizationAngle.minimum=i.getNormalizationAngleMinimumValue(o),this._physicsRig.settings.at(o).normalizationAngle.maximum=i.getNormalizationAngleMaximumValue(o),this._physicsRig.settings.at(o).normalizationAngle.defalut=i.getNormalizationAngleDefaultValue(o),this._physicsRig.settings.at(o).inputCount=i.getInputCount(o),this._physicsRig.settings.at(o).baseInputIndex=s;for(let h=0;h<this._physicsRig.settings.at(o).inputCount;++h)this._physicsRig.inputs.at(s+h).sourceParameterIndex=-1,this._physicsRig.inputs.at(s+h).weight=i.getInputWeight(o,h),this._physicsRig.inputs.at(s+h).reflect=i.getInputReflect(o,h),i.getInputType(o,h)==pi?(this._physicsRig.inputs.at(s+h).type=Q.CubismPhysicsSource_X,this._physicsRig.inputs.at(s+h).getNormalizedParameterValue=Br):i.getInputType(o,h)==fi?(this._physicsRig.inputs.at(s+h).type=Q.CubismPhysicsSource_Y,this._physicsRig.inputs.at(s+h).getNormalizedParameterValue=Vr):i.getInputType(o,h)==yi&&(this._physicsRig.inputs.at(s+h).type=Q.CubismPhysicsSource_Angle,this._physicsRig.inputs.at(s+h).getNormalizedParameterValue=Ir),this._physicsRig.inputs.at(s+h).source.targetType=qt.CubismPhysicsTargetType_Parameter,this._physicsRig.inputs.at(s+h).source.id=i.getInputSourceId(o,h);s+=this._physicsRig.settings.at(o).inputCount,this._physicsRig.settings.at(o).outputCount=i.getOutputCount(o),this._physicsRig.settings.at(o).baseOutputIndex=a;const l=new xi;l.outputs.resize(this._physicsRig.settings.at(o).outputCount);const u=new xi;u.outputs.resize(this._physicsRig.settings.at(o).outputCount);for(let h=0;h<this._physicsRig.settings.at(o).outputCount;++h)l.outputs.set(h,0),u.outputs.set(h,0),this._physicsRig.outputs.at(a+h).destinationParameterIndex=-1,this._physicsRig.outputs.at(a+h).vertexIndex=i.getOutputVertexIndex(o,h),this._physicsRig.outputs.at(a+h).angleScale=i.getOutputAngleScale(o,h),this._physicsRig.outputs.at(a+h).weight=i.getOutputWeight(o,h),this._physicsRig.outputs.at(a+h).destination.targetType=qt.CubismPhysicsTargetType_Parameter,this._physicsRig.outputs.at(a+h).destination.id=i.getOutputDestinationId(o,h),i.getOutputType(o,h)==pi?(this._physicsRig.outputs.at(a+h).type=Q.CubismPhysicsSource_X,this._physicsRig.outputs.at(a+h).getValue=Fr,this._physicsRig.outputs.at(a+h).getScale=Dr):i.getOutputType(o,h)==fi?(this._physicsRig.outputs.at(a+h).type=Q.CubismPhysicsSource_Y,this._physicsRig.outputs.at(a+h).getValue=wr,this._physicsRig.outputs.at(a+h).getScale=Lr):i.getOutputType(o,h)==yi&&(this._physicsRig.outputs.at(a+h).type=Q.CubismPhysicsSource_Angle,this._physicsRig.outputs.at(a+h).getValue=Tr,this._physicsRig.outputs.at(a+h).getScale=Or),this._physicsRig.outputs.at(a+h).reflect=i.getOutputReflect(o,h);this._currentRigOutputs.pushBack(l),this._previousRigOutputs.pushBack(u),a+=this._physicsRig.settings.at(o).outputCount,this._physicsRig.settings.at(o).particleCount=i.getParticleCount(o),this._physicsRig.settings.at(o).baseParticleIndex=n;for(let h=0;h<this._physicsRig.settings.at(o).particleCount;++h)this._physicsRig.particles.at(n+h).mobility=i.getParticleMobility(o,h),this._physicsRig.particles.at(n+h).delay=i.getParticleDelay(o,h),this._physicsRig.particles.at(n+h).acceleration=i.getParticleAcceleration(o,h),this._physicsRig.particles.at(n+h).radius=i.getParticleRadius(o,h),this._physicsRig.particles.at(n+h).position=i.getParticlePosition(o,h);n+=this._physicsRig.settings.at(o).particleCount}this.initialize(),i.release(),i=void 0,i=null}stabilization(t){let e,i,s,a;const n=new C;let o,l,u,h;const g=t.getModel().parameters.values,m=t.getModel().parameters.maximumValues,c=t.getModel().parameters.minimumValues,d=t.getModel().parameters.defaultValues;(this._parameterCaches?.length??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(this._parameterInputCaches?.length??0)<t.getParameterCount()&&(this._parameterInputCaches=new Float32Array(t.getParameterCount()));for(let p=0;p<t.getParameterCount();++p)this._parameterCaches[p]=g[p],this._parameterInputCaches[p]=g[p];for(let p=0;p<this._physicsRig.subRigCount;++p){e={angle:0},n.x=0,n.y=0,o=this._physicsRig.settings.at(p),l=this._physicsRig.inputs.get(o.baseInputIndex),u=this._physicsRig.outputs.get(o.baseOutputIndex),h=this._physicsRig.particles.get(o.baseParticleIndex);for(let _=0;_<o.inputCount;++_)i=l[_].weight/xe,l[_].sourceParameterIndex==-1&&(l[_].sourceParameterIndex=t.getParameterIndex(l[_].source.id)),l[_].getNormalizedParameterValue(n,e,g[l[_].sourceParameterIndex],c[l[_].sourceParameterIndex],m[l[_].sourceParameterIndex],d[l[_].sourceParameterIndex],o.normalizationPosition,o.normalizationAngle,l[_].reflect,i),this._parameterCaches[l[_].sourceParameterIndex]=g[l[_].sourceParameterIndex];s=M.degreesToRadian(-e.angle),n.x=n.x*M.cos(s)-n.y*M.sin(s),n.y=n.x*M.sin(s)+n.y*M.cos(s),kr(h,o.particleCount,n,e.angle,this._options.wind,Ci*o.normalizationPosition.maximum);for(let _=0;_<o.outputCount;++_){const S=u[_].vertexIndex;if(u[_].destinationParameterIndex==-1&&(u[_].destinationParameterIndex=t.getParameterIndex(u[_].destination.id)),S<1||S>=o.particleCount)continue;let b=new C;b=h[S].position.substract(h[S-1].position),a=u[_].getValue(b,h,S,u[_].reflect,this._options.gravity),this._currentRigOutputs.at(p).outputs.set(_,a),this._previousRigOutputs.at(p).outputs.set(_,a);const f=u[_].destinationParameterIndex,y=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(g.subarray(f))):g.slice(f);ae(y,c[f],m[f],a,u[_]);for(let P=f,v=0;P<this._parameterCaches.length;P++,v++)g[P]=this._parameterCaches[P]=y[v]}}}evaluate(t,e){let i,s,a,n;const o=new C;let l,u,h,g;if(0>=e)return;const m=t.getModel().parameters.values,c=t.getModel().parameters.maximumValues,d=t.getModel().parameters.minimumValues,p=t.getModel().parameters.defaultValues;let _;if(this._currentRemainTime+=e,this._currentRemainTime>Pr&&(this._currentRemainTime=0),(this._parameterCaches?.length??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(this._parameterInputCaches?.length??0)<t.getParameterCount()){this._parameterInputCaches=new Float32Array(t.getParameterCount());for(let b=0;b<t.getParameterCount();++b)this._parameterInputCaches[b]=m[b]}for(this._physicsRig.fps>0?_=1/this._physicsRig.fps:_=e;this._currentRemainTime>=_;){for(let f=0;f<this._physicsRig.subRigCount;++f){l=this._physicsRig.settings.at(f),h=this._physicsRig.outputs.get(l.baseOutputIndex);for(let y=0;y<l.outputCount;++y)this._previousRigOutputs.at(f).outputs.set(y,this._currentRigOutputs.at(f).outputs.at(y))}const b=_/this._currentRemainTime;for(let f=0;f<t.getParameterCount();++f)this._parameterCaches[f]=this._parameterInputCaches[f]*(1-b)+m[f]*b,this._parameterInputCaches[f]=this._parameterCaches[f];for(let f=0;f<this._physicsRig.subRigCount;++f){i={angle:0},o.x=0,o.y=0,l=this._physicsRig.settings.at(f),u=this._physicsRig.inputs.get(l.baseInputIndex),h=this._physicsRig.outputs.get(l.baseOutputIndex),g=this._physicsRig.particles.get(l.baseParticleIndex);for(let y=0;y<l.inputCount;++y)s=u[y].weight/xe,u[y].sourceParameterIndex==-1&&(u[y].sourceParameterIndex=t.getParameterIndex(u[y].source.id)),u[y].getNormalizedParameterValue(o,i,this._parameterCaches[u[y].sourceParameterIndex],d[u[y].sourceParameterIndex],c[u[y].sourceParameterIndex],p[u[y].sourceParameterIndex],l.normalizationPosition,l.normalizationAngle,u[y].reflect,s);a=M.degreesToRadian(-i.angle),o.x=o.x*M.cos(a)-o.y*M.sin(a),o.y=o.x*M.sin(a)+o.y*M.cos(a),Ar(g,l.particleCount,o,i.angle,this._options.wind,Ci*l.normalizationPosition.maximum,_,br);for(let y=0;y<l.outputCount;++y){const P=h[y].vertexIndex;if(h[y].destinationParameterIndex==-1&&(h[y].destinationParameterIndex=t.getParameterIndex(h[y].destination.id)),P<1||P>=l.particleCount)continue;const v=new C;v.x=g[P].position.x-g[P-1].position.x,v.y=g[P].position.y-g[P-1].position.y,n=h[y].getValue(v,g,P,h[y].reflect,this._options.gravity),this._currentRigOutputs.at(f).outputs.set(y,n);const T=h[y].destinationParameterIndex,G=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(this._parameterCaches.subarray(T))):this._parameterCaches.slice(T);ae(G,d[T],c[T],n,h[y]);for(let V=T,R=0;V<this._parameterCaches.length;V++,R++)this._parameterCaches[V]=G[R]}}this._currentRemainTime-=_}const S=this._currentRemainTime/_;this.interpolate(t,S)}interpolate(t,e){let i,s;const a=t.getModel().parameters.values,n=t.getModel().parameters.maximumValues,o=t.getModel().parameters.minimumValues;for(let l=0;l<this._physicsRig.subRigCount;++l){s=this._physicsRig.settings.at(l),i=this._physicsRig.outputs.get(s.baseOutputIndex);for(let u=0;u<s.outputCount;++u){if(i[u].destinationParameterIndex==-1)continue;const h=i[u].destinationParameterIndex,g=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(a.subarray(h))):a.slice(h);ae(g,o[h],n[h],this._previousRigOutputs.at(l).outputs.at(u)*(1-e)+this._currentRigOutputs.at(l).outputs.at(u)*e,i[u]);for(let m=h,c=0;m<a.length;m++,c++)a[m]=g[c]}}}setOptions(t){this._options=t}getOption(){return this._options}constructor(){this._physicsRig=null,this._options=new ds,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0,this._currentRigOutputs=new x,this._previousRigOutputs=new x,this._currentRemainTime=0,this._parameterCaches=null,this._parameterInputCaches=null}release(){this._physicsRig=void 0,this._physicsRig=null}initialize(){let t,e,i;for(let s=0;s<this._physicsRig.subRigCount;++s){e=this._physicsRig.settings.at(s),t=this._physicsRig.particles.get(e.baseParticleIndex),t[0].initialPosition=new C(0,0),t[0].lastPosition=new C(t[0].initialPosition.x,t[0].initialPosition.y),t[0].lastGravity=new C(0,-1),t[0].lastGravity.y*=-1,t[0].velocity=new C(0,0),t[0].force=new C(0,0);for(let a=1;a<e.particleCount;++a)i=new C(0,0),i.y=t[a].radius,t[a].initialPosition=new C(t[a-1].initialPosition.x+i.x,t[a-1].initialPosition.y+i.y),t[a].position=new C(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastPosition=new C(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastGravity=new C(0,-1),t[a].lastGravity.y*=-1,t[a].velocity=new C(0,0),t[a].force=new C(0,0)}}};class ds{constructor(){this.gravity=new C(0,0),this.wind=new C(0,0)}}class xi{constructor(){this.outputs=new x(0)}}function vr(r){let t=0;return r>0?t=1:r<0&&(t=-1),t}function Br(r,t,e,i,s,a,n,o,l,u){r.x+=Fe(e,i,s,a,n.minimum,n.maximum,n.defalut,l)*u}function Vr(r,t,e,i,s,a,n,o,l,u){r.y+=Fe(e,i,s,a,n.minimum,n.maximum,n.defalut,l)*u}function Ir(r,t,e,i,s,a,n,o,l,u){t.angle+=Fe(e,i,s,a,o.minimum,o.maximum,o.defalut,l)*u}function Fr(r,t,e,i,s){let a=r.x;return i&&(a*=-1),a}function wr(r,t,e,i,s){let a=r.y;return i&&(a*=-1),a}function Tr(r,t,e,i,s){let a;return e>=2?s=t[e-1].position.substract(t[e-2].position):s=s.multiplyByScaler(-1),a=M.directionToRadian(s,r),i&&(a*=-1),a}function Rr(r,t){const e=M.max(r,t),i=M.min(r,t);return M.abs(e-i)}function Er(r,t){return M.min(r,t)+Rr(r,t)/2}function Dr(r,t){return JSON.parse(JSON.stringify(r.x))}function Lr(r,t){return JSON.parse(JSON.stringify(r.y))}function Or(r,t){return JSON.parse(JSON.stringify(t))}function Ar(r,t,e,i,s,a,n,o){let l,u,h=new C(0,0),g=new C(0,0),m=new C(0,0),c=new C(0,0);r[0].position=new C(e.x,e.y);const d=M.degreesToRadian(i),p=M.radianToDirection(d);p.normalize();for(let _=1;_<t;++_)r[_].force=p.multiplyByScaler(r[_].acceleration).add(s),r[_].lastPosition=new C(r[_].position.x,r[_].position.y),l=r[_].delay*n*30,h=r[_].position.substract(r[_-1].position),u=M.directionToRadian(r[_].lastGravity,p)/o,h.x=M.cos(u)*h.x-h.y*M.sin(u),h.y=M.sin(u)*h.x+h.y*M.cos(u),r[_].position=r[_-1].position.add(h),g=r[_].velocity.multiplyByScaler(l),m=r[_].force.multiplyByScaler(l).multiplyByScaler(l),r[_].position=r[_].position.add(g).add(m),c=r[_].position.substract(r[_-1].position),c.normalize(),r[_].position=r[_-1].position.add(c.multiplyByScaler(r[_].radius)),M.abs(r[_].position.x)<a&&(r[_].position.x=0),l!=0&&(r[_].velocity=r[_].position.substract(r[_].lastPosition),r[_].velocity=r[_].velocity.divisionByScalar(l),r[_].velocity=r[_].velocity.multiplyByScaler(r[_].mobility)),r[_].force=new C(0,0),r[_].lastGravity=new C(p.x,p.y)}function kr(r,t,e,i,s,a){let n=new C(0,0);r[0].position=new C(e.x,e.y);const o=M.degreesToRadian(i),l=M.radianToDirection(o);l.normalize();for(let u=1;u<t;++u)r[u].force=l.multiplyByScaler(r[u].acceleration).add(s),r[u].lastPosition=new C(r[u].position.x,r[u].position.y),r[u].velocity=new C(0,0),n=r[u].force,n.normalize(),n=n.multiplyByScaler(r[u].radius),r[u].position=r[u-1].position.add(n),M.abs(r[u].position.x)<a&&(r[u].position.x=0),r[u].force=new C(0,0),r[u].lastGravity=new C(l.x,l.y)}function ae(r,t,e,i,s){let a;const n=s.getScale(s.translationScale,s.angleScale);a=i*n,a<t?(a<s.valueBelowMinimum&&(s.valueBelowMinimum=a),a=t):a>e&&(a>s.valueExceededMaximum&&(s.valueExceededMaximum=a),a=e);const o=s.weight/xe;o>=1||(a=r[0]*(1-o)+a*o),r[0]=a}function Fe(r,t,e,i,s,a,n,o){let l=0;const u=M.max(e,t);u<r&&(r=u);const h=M.min(e,t);h>r&&(r=h);const g=M.min(s,a),m=M.max(s,a),c=n,d=Er(h,u),p=r-d;switch(vr(p)){case 1:{const _=m-c,S=u-d;S!=0&&(l=p*(_/S),l+=c);break}case-1:{const _=g-c,S=h-d;S!=0&&(l=p*(_/S),l+=c);break}case 0:{l=c;break}}return o?l:l*-1}var Me;(r=>{r.CubismPhysics=Se,r.Options=ds})(Me||(Me={}));const ne=4,Ur=36,Nr=32;class zr{constructor(t){this._renderTextureCount=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=new x,this._clippingContextListForDraw=new x,this._channelColors=new x,this._tmpBoundsOnModel=new Xt,this._tmpMatrix=new et,this._tmpMatrixForMask=new et,this._tmpMatrixForDraw=new et,this._clippingContexttConstructor=t;let e=new k;e.r=1,e.g=0,e.b=0,e.a=0,this._channelColors.pushBack(e),e=new k,e.r=0,e.g=1,e.b=0,e.a=0,this._channelColors.pushBack(e),e=new k,e.r=0,e.g=0,e.b=1,e.a=0,this._channelColors.pushBack(e),e=new k,e.r=0,e.g=0,e.b=0,e.a=1,this._channelColors.pushBack(e)}release(){for(let t=0;t<this._clippingContextListForMask.getSize();t++)this._clippingContextListForMask.at(t)&&(this._clippingContextListForMask.at(t).release(),this._clippingContextListForMask.set(t,void 0)),this._clippingContextListForMask.set(t,null);this._clippingContextListForMask=null;for(let t=0;t<this._clippingContextListForDraw.getSize();t++)this._clippingContextListForDraw.set(t,null);this._clippingContextListForDraw=null;for(let t=0;t<this._channelColors.getSize();t++)this._channelColors.set(t,null);this._channelColors=null,this._clearedFrameBufferFlags!=null&&this._clearedFrameBufferFlags.clear(),this._clearedFrameBufferFlags=null}initialize(t,e){e%1!=0&&(B("The number of render textures must be specified as an integer. The decimal point is rounded down and corrected to an integer."),e=~~e),e<1&&B("The number of render textures must be an integer greater than or equal to 1. Set the number of render textures to 1."),this._renderTextureCount=e<1?1:e,this._clearedFrameBufferFlags=new x(this._renderTextureCount);for(let i=0;i<t.getDrawableCount();i++){if(t.getDrawableMaskCounts()[i]<=0){this._clippingContextListForDraw.pushBack(null);continue}let s=this.findSameClip(t.getDrawableMasks()[i],t.getDrawableMaskCounts()[i]);s==null&&(s=new this._clippingContexttConstructor(this,t.getDrawableMasks()[i],t.getDrawableMaskCounts()[i]),this._clippingContextListForMask.pushBack(s)),s.addClippedDrawable(i),this._clippingContextListForDraw.pushBack(s)}}findSameClip(t,e){for(let i=0;i<this._clippingContextListForMask.getSize();i++){const s=this._clippingContextListForMask.at(i),a=s._clippingIdCount;if(a!=e)continue;let n=0;for(let o=0;o<a;o++){const l=s._clippingIdList[o];for(let u=0;u<a;u++)if(t[u]==l){n++;break}}if(n==a)return s}return null}setupMatrixForHighPrecision(t,e){let i=0;for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s);this.calcClippedDrawTotalBounds(t,a),a._isUsing&&i++}if(i>0){if(this.setupLayoutBounds(0),this._clearedFrameBufferFlags.getSize()!=this._renderTextureCount){this._clearedFrameBufferFlags.clear();for(let s=0;s<this._renderTextureCount;s++)this._clearedFrameBufferFlags.pushBack(!1)}else for(let s=0;s<this._renderTextureCount;s++)this._clearedFrameBufferFlags.set(s,!1);for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s),n=a._allClippedDrawRect,o=a._layoutBounds,l=.05;let u=0,h=0;const g=t.getPixelsPerUnit(),m=a.getClippingManager().getClippingMaskBufferSize(),c=o.width*m,d=o.height*m;this._tmpBoundsOnModel.setRect(n),this._tmpBoundsOnModel.width*g>c?(this._tmpBoundsOnModel.expand(n.width*l,0),u=o.width/this._tmpBoundsOnModel.width):u=g/c,this._tmpBoundsOnModel.height*g>d?(this._tmpBoundsOnModel.expand(0,n.height*l),h=o.height/this._tmpBoundsOnModel.height):h=g/d,this.createMatrixForMask(e,o,u,h),a._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),a._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray())}}}createMatrixForMask(t,e,i,s){this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(e.x,e.y),this._tmpMatrix.scaleRelative(i,s),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(e.x,e.y*(t?-1:1)),this._tmpMatrix.scaleRelative(i,s*(t?-1:1)),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray())}setupLayoutBounds(t){const e=this._renderTextureCount<=1?Ur:Nr*this._renderTextureCount;if(t<=0||t>e){t>e&&w(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let u=0;u<this._clippingContextListForMask.getSize();u++){const h=this._clippingContextListForMask.at(u);h._layoutChannelIndex=0,h._layoutBounds.x=0,h._layoutBounds.y=0,h._layoutBounds.width=1,h._layoutBounds.height=1,h._bufferIndex=0}return}const i=this._renderTextureCount<=1?9:8;let s=t/this._renderTextureCount;const a=t%this._renderTextureCount;s=Math.ceil(s);let n=s/ne;const o=s%ne;n=~~n;let l=0;for(let u=0;u<this._renderTextureCount;u++)for(let h=0;h<ne;h++){let g=n+(h<o?1:0);const m=o+(n<1?-1:0);if(h==m&&a>0&&(g-=u<a?0:1),g!=0)if(g==1){const c=this._clippingContextListForMask.at(l++);c._layoutChannelIndex=h,c._layoutBounds.x=0,c._layoutBounds.y=0,c._layoutBounds.width=1,c._layoutBounds.height=1,c._bufferIndex=u}else if(g==2)for(let c=0;c<g;c++){let d=c%2;d=~~d;const p=this._clippingContextListForMask.at(l++);p._layoutChannelIndex=h,p._layoutBounds.x=d*.5,p._layoutBounds.y=0,p._layoutBounds.width=.5,p._layoutBounds.height=1,p._bufferIndex=u}else if(g<=4)for(let c=0;c<g;c++){let d=c%2,p=c/2;d=~~d,p=~~p;const _=this._clippingContextListForMask.at(l++);_._layoutChannelIndex=h,_._layoutBounds.x=d*.5,_._layoutBounds.y=p*.5,_._layoutBounds.width=.5,_._layoutBounds.height=.5,_._bufferIndex=u}else if(g<=i)for(let c=0;c<g;c++){let d=c%3,p=c/3;d=~~d,p=~~p;const _=this._clippingContextListForMask.at(l++);_._layoutChannelIndex=h,_._layoutBounds.x=d/3,_._layoutBounds.y=p/3,_._layoutBounds.width=1/3,_._layoutBounds.height=1/3,_._bufferIndex=u}else{w(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let c=0;c<g;c++){const d=this._clippingContextListForMask.at(l++);d._layoutChannelIndex=0,d._layoutBounds.x=0,d._layoutBounds.y=0,d._layoutBounds.width=1,d._layoutBounds.height=1,d._bufferIndex=0}}}}calcClippedDrawTotalBounds(t,e){let i=Number.MAX_VALUE,s=Number.MAX_VALUE,a=Number.MIN_VALUE,n=Number.MIN_VALUE;const o=e._clippedDrawableIndexList.length;for(let l=0;l<o;l++){const u=e._clippedDrawableIndexList[l],h=t.getDrawableVertexCount(u),g=t.getDrawableVertices(u);let m=Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,p=-Number.MAX_VALUE;const _=h*tt.vertexStep;for(let S=tt.vertexOffset;S<_;S+=tt.vertexStep){const b=g[S],f=g[S+1];b<m&&(m=b),b>d&&(d=b),f<c&&(c=f),f>p&&(p=f)}if(m!=Number.MAX_VALUE)if(m<i&&(i=m),c<s&&(s=c),d>a&&(a=d),p>n&&(n=p),i==Number.MAX_VALUE)e._allClippedDrawRect.x=0,e._allClippedDrawRect.y=0,e._allClippedDrawRect.width=0,e._allClippedDrawRect.height=0,e._isUsing=!1;else{e._isUsing=!0;const S=a-i,b=n-s;e._allClippedDrawRect.x=i,e._allClippedDrawRect.y=s,e._allClippedDrawRect.width=S,e._allClippedDrawRect.height=b}}}getClippingContextListForDraw(){return this._clippingContextListForDraw}getClippingMaskBufferSize(){return this._clippingMaskBufferSize}getRenderTextureCount(){return this._renderTextureCount}getChannelFlagAsColor(t){return this._channelColors.at(t)}setClippingMaskBufferSize(t){this._clippingMaskBufferSize=t}}let ct;const jr=10;class _s{constructor(){this._shaderSets=new x}release(){this.releaseShaderProgram()}setupShaderProgramForDraw(t,e,i){t.isPremultipliedAlpha()||w("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();let s,a,n,o;const l=t.getClippingContextBufferForDraw()!=null,u=e.getDrawableInvertedMaskBit(i),h=l?u?2:1:0;let g;switch(e.getDrawableBlendMode(i)){case it.CubismBlendMode_Normal:default:g=this._shaderSets.at(1+h),s=this.gl.ONE,a=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ONE,o=this.gl.ONE_MINUS_SRC_ALPHA;break;case it.CubismBlendMode_Additive:g=this._shaderSets.at(4+h),s=this.gl.ONE,a=this.gl.ONE,n=this.gl.ZERO,o=this.gl.ONE;break;case it.CubismBlendMode_Multiplicative:g=this._shaderSets.at(7+h),s=this.gl.DST_COLOR,a=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ZERO,o=this.gl.ONE;break}this.gl.useProgram(g.shaderProgram),t._bufferData.vertex==null&&(t._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t._bufferData.vertex);const m=e.getDrawableVertices(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,m,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(g.attributePositionLocation),this.gl.vertexAttribPointer(g.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),t._bufferData.uv==null&&(t._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t._bufferData.uv);const c=e.getDrawableVertexUvs(i);if(this.gl.bufferData(this.gl.ARRAY_BUFFER,c,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(g.attributeTexCoordLocation),this.gl.vertexAttribPointer(g.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),l){this.gl.activeTexture(this.gl.TEXTURE1);const P=t.getClippingContextBufferForDraw().getClippingManager().getColorBuffer().at(t.getClippingContextBufferForDraw()._bufferIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,P),this.gl.uniform1i(g.samplerTexture1Location,1),this.gl.uniformMatrix4fv(g.uniformClipMatrixLocation,!1,t.getClippingContextBufferForDraw()._matrixForDraw.getArray());const v=t.getClippingContextBufferForDraw()._layoutChannelIndex,T=t.getClippingContextBufferForDraw().getClippingManager().getChannelFlagAsColor(v);this.gl.uniform4f(g.uniformChannelFlagLocation,T.r,T.g,T.b,T.a)}const d=e.getDrawableTextureIndex(i),p=t.getBindedTextures().getValue(d);this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,p),this.gl.uniform1i(g.samplerTexture0Location,0);const _=t.getMvpMatrix();this.gl.uniformMatrix4fv(g.uniformMatrixLocation,!1,_.getArray());const S=t.getModelColorWithOpacity(e.getDrawableOpacity(i)),b=e.getMultiplyColor(i),f=e.getScreenColor(i);this.gl.uniform4f(g.uniformBaseColorLocation,S.r,S.g,S.b,S.a),this.gl.uniform4f(g.uniformMultiplyColorLocation,b.r,b.g,b.b,b.a),this.gl.uniform4f(g.uniformScreenColorLocation,f.r,f.g,f.b,f.a),t._bufferData.index==null&&(t._bufferData.index=this.gl.createBuffer());const y=e.getDrawableVertexIndices(i);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,t._bufferData.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,y,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(s,a,n,o)}setupShaderProgramForMask(t,e,i){t.isPremultipliedAlpha()||w("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();const s=this._shaderSets.at(0);this.gl.useProgram(s.shaderProgram),t._bufferData.vertex==null&&(t._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t._bufferData.vertex);const a=e.getDrawableVertices(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(s.attributePositionLocation),this.gl.vertexAttribPointer(s.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),t._bufferData.uv==null&&(t._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t._bufferData.uv);const n=e.getDrawableTextureIndex(i),o=t.getBindedTextures().getValue(n);this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,o),this.gl.uniform1i(s.samplerTexture0Location,0),t._bufferData.uv==null&&(t._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t._bufferData.uv);const l=e.getDrawableVertexUvs(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,l,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(s.attributeTexCoordLocation),this.gl.vertexAttribPointer(s.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),t.getClippingContextBufferForMask();const u=t.getClippingContextBufferForMask()._layoutChannelIndex,h=t.getClippingContextBufferForMask().getClippingManager().getChannelFlagAsColor(u);this.gl.uniform4f(s.uniformChannelFlagLocation,h.r,h.g,h.b,h.a),this.gl.uniformMatrix4fv(s.uniformClipMatrixLocation,!1,t.getClippingContextBufferForMask()._matrixForMask.getArray());const g=t.getClippingContextBufferForMask()._layoutBounds;this.gl.uniform4f(s.uniformBaseColorLocation,g.x*2-1,g.y*2-1,g.getRight()*2-1,g.getBottom()*2-1);const m=e.getMultiplyColor(i),c=e.getScreenColor(i);this.gl.uniform4f(s.uniformMultiplyColorLocation,m.r,m.g,m.b,m.a),this.gl.uniform4f(s.uniformScreenColorLocation,c.r,c.g,c.b,c.a);const d=this.gl.ZERO,p=this.gl.ONE_MINUS_SRC_COLOR,_=this.gl.ZERO,S=this.gl.ONE_MINUS_SRC_ALPHA;t._bufferData.index==null&&(t._bufferData.index=this.gl.createBuffer());const b=e.getDrawableVertexIndices(i);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,t._bufferData.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,b,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(d,p,_,S)}releaseShaderProgram(){for(let t=0;t<this._shaderSets.getSize();t++)this.gl.deleteProgram(this._shaderSets.at(t).shaderProgram),this._shaderSets.at(t).shaderProgram=0,this._shaderSets.set(t,void 0),this._shaderSets.set(t,null)}generateShaders(){for(let t=0;t<jr;t++)this._shaderSets.pushBack(new ms);this._shaderSets.at(0).shaderProgram=this.loadShaderProgram(Xr,Gr),this._shaderSets.at(1).shaderProgram=this.loadShaderProgram(Yr,Wr),this._shaderSets.at(2).shaderProgram=this.loadShaderProgram(Si,qr),this._shaderSets.at(3).shaderProgram=this.loadShaderProgram(Si,Hr),this._shaderSets.at(4).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(5).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(6).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(7).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(8).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(9).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(0).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_position"),this._shaderSets.at(0).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_texCoord"),this._shaderSets.at(0).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"s_texture0"),this._shaderSets.at(0).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_clipMatrix"),this._shaderSets.at(0).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_channelFlag"),this._shaderSets.at(0).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_baseColor"),this._shaderSets.at(0).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_multiplyColor"),this._shaderSets.at(0).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_screenColor"),this._shaderSets.at(1).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_position"),this._shaderSets.at(1).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_texCoord"),this._shaderSets.at(1).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"s_texture0"),this._shaderSets.at(1).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_matrix"),this._shaderSets.at(1).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_baseColor"),this._shaderSets.at(1).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_multiplyColor"),this._shaderSets.at(1).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_screenColor"),this._shaderSets.at(2).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_position"),this._shaderSets.at(2).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_texCoord"),this._shaderSets.at(2).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture0"),this._shaderSets.at(2).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture1"),this._shaderSets.at(2).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_matrix"),this._shaderSets.at(2).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_clipMatrix"),this._shaderSets.at(2).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_channelFlag"),this._shaderSets.at(2).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_baseColor"),this._shaderSets.at(2).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_multiplyColor"),this._shaderSets.at(2).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_screenColor"),this._shaderSets.at(3).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_position"),this._shaderSets.at(3).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_texCoord"),this._shaderSets.at(3).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture0"),this._shaderSets.at(3).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture1"),this._shaderSets.at(3).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_matrix"),this._shaderSets.at(3).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_clipMatrix"),this._shaderSets.at(3).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_channelFlag"),this._shaderSets.at(3).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_baseColor"),this._shaderSets.at(3).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_multiplyColor"),this._shaderSets.at(3).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_screenColor"),this._shaderSets.at(4).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_position"),this._shaderSets.at(4).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_texCoord"),this._shaderSets.at(4).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"s_texture0"),this._shaderSets.at(4).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_matrix"),this._shaderSets.at(4).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_baseColor"),this._shaderSets.at(4).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_multiplyColor"),this._shaderSets.at(4).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_screenColor"),this._shaderSets.at(5).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_position"),this._shaderSets.at(5).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_texCoord"),this._shaderSets.at(5).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture0"),this._shaderSets.at(5).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture1"),this._shaderSets.at(5).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_matrix"),this._shaderSets.at(5).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_clipMatrix"),this._shaderSets.at(5).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_channelFlag"),this._shaderSets.at(5).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_baseColor"),this._shaderSets.at(5).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_multiplyColor"),this._shaderSets.at(5).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_screenColor"),this._shaderSets.at(6).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_position"),this._shaderSets.at(6).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_texCoord"),this._shaderSets.at(6).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture0"),this._shaderSets.at(6).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture1"),this._shaderSets.at(6).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_matrix"),this._shaderSets.at(6).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_clipMatrix"),this._shaderSets.at(6).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_channelFlag"),this._shaderSets.at(6).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_baseColor"),this._shaderSets.at(6).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_multiplyColor"),this._shaderSets.at(6).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_screenColor"),this._shaderSets.at(7).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_position"),this._shaderSets.at(7).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_texCoord"),this._shaderSets.at(7).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"s_texture0"),this._shaderSets.at(7).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_matrix"),this._shaderSets.at(7).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_baseColor"),this._shaderSets.at(7).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_multiplyColor"),this._shaderSets.at(7).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_screenColor"),this._shaderSets.at(8).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_position"),this._shaderSets.at(8).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_texCoord"),this._shaderSets.at(8).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture0"),this._shaderSets.at(8).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture1"),this._shaderSets.at(8).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_matrix"),this._shaderSets.at(8).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_clipMatrix"),this._shaderSets.at(8).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_channelFlag"),this._shaderSets.at(8).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_baseColor"),this._shaderSets.at(8).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_multiplyColor"),this._shaderSets.at(8).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_screenColor"),this._shaderSets.at(9).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_position"),this._shaderSets.at(9).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_texCoord"),this._shaderSets.at(9).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture0"),this._shaderSets.at(9).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture1"),this._shaderSets.at(9).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_matrix"),this._shaderSets.at(9).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_clipMatrix"),this._shaderSets.at(9).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_channelFlag"),this._shaderSets.at(9).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_baseColor"),this._shaderSets.at(9).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_multiplyColor"),this._shaderSets.at(9).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_screenColor")}loadShaderProgram(t,e){let i=this.gl.createProgram(),s=this.compileShaderSource(this.gl.VERTEX_SHADER,t);if(!s)return w("Vertex shader compile error!"),0;let a=this.compileShaderSource(this.gl.FRAGMENT_SHADER,e);return a?(this.gl.attachShader(i,s),this.gl.attachShader(i,a),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?(this.gl.deleteShader(s),this.gl.deleteShader(a),i):(w("Failed to link program: {0}",i),this.gl.deleteShader(s),s=0,this.gl.deleteShader(a),a=0,i&&(this.gl.deleteProgram(i),i=0),0)):(w("Vertex shader compile error!"),0)}compileShaderSource(t,e){const i=e,s=this.gl.createShader(t);if(this.gl.shaderSource(s,i),this.gl.compileShader(s),!s){const n=this.gl.getShaderInfoLog(s);w("Shader compile log: {0} ",n)}return this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)?s:(this.gl.deleteShader(s),null)}setGl(t){this.gl=t}}class ot{static getInstance(){return ct==null&&(ct=new ot),ct}static deleteInstance(){ct&&(ct.release(),ct=null)}constructor(){this._shaderMap=new H}release(){for(const t=this._shaderMap.begin();t.notEqual(this._shaderMap.end());t.preIncrement())t.ptr().second.release();this._shaderMap.clear()}getShader(t){return this._shaderMap.getValue(t)}setGlContext(t){if(!this._shaderMap.isExist(t)){const e=new _s;e.setGl(t),this._shaderMap.setValue(t,e)}}}class ms{}var ps=(r=>(r[r.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",r[r.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",r[r.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",r[r.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",r[r.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",r[r.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",r[r.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",r[r.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",r[r.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",r[r.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted",r))(ps||{});const Xr="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Gr="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",Yr="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Si="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Wr="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 color = texColor * u_baseColor;   gl_FragColor = vec4(color.rgb, color.a);}",qr="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",Hr="precision mediump float;varying vec2      v_texCoord;varying vec4      v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4      u_channelFlag;uniform vec4      u_baseColor;uniform vec4      u_multiplyColor;uniform vec4      u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * (1.0 - maskVal);   gl_FragColor = col_formask;}";var Mi;(r=>{r.CubismShaderSet=ms,r.CubismShader_WebGL=_s,r.CubismShaderManager_WebGL=ot,r.ShaderNames=ps})(Mi||(Mi={}));let Z,Ht;class be extends zr{getMaskRenderTexture(){if(this._maskTexture&&this._maskTexture.textures!=null)this._maskTexture.frameNo=this._currentFrameNo;else{this._maskRenderTextures!=null&&this._maskRenderTextures.clear(),this._maskRenderTextures=new x,this._maskColorBuffers!=null&&this._maskColorBuffers.clear(),this._maskColorBuffers=new x;const t=this._clippingMaskBufferSize;for(let e=0;e<this._renderTextureCount;e++)this._maskColorBuffers.pushBack(this.gl.createTexture()),this.gl.bindTexture(this.gl.TEXTURE_2D,this._maskColorBuffers.at(e)),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this._maskRenderTextures.pushBack(this.gl.createFramebuffer()),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._maskRenderTextures.at(e)),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this._maskColorBuffers.at(e),0);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,Ht),this._maskTexture=new fs(this._currentFrameNo,this._maskRenderTextures)}return this._maskTexture.textures}setGL(t){this.gl=t}constructor(){super(ys)}setupClippingContext(t,e){this._currentFrameNo++;let i=0;for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s);this.calcClippedDrawTotalBounds(t,a),a._isUsing&&i++}if(i>0){this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),this._currentMaskRenderTexture=this.getMaskRenderTexture().at(0),e.preDraw(),this.setupLayoutBounds(i),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture),this._clearedFrameBufferFlags.getSize()!=this._renderTextureCount&&(this._clearedFrameBufferFlags.clear(),this._clearedFrameBufferFlags=new x(this._renderTextureCount));for(let s=0;s<this._clearedFrameBufferFlags.getSize();s++)this._clearedFrameBufferFlags.set(s,!1);for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s),n=a._allClippedDrawRect,o=a._layoutBounds,l=.05;let u=0,h=0;const g=this.getMaskRenderTexture().at(a._bufferIndex);this._currentMaskRenderTexture!=g&&(this._currentMaskRenderTexture=g,e.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture)),this._tmpBoundsOnModel.setRect(n),this._tmpBoundsOnModel.expand(n.width*l,n.height*l),u=o.width/this._tmpBoundsOnModel.width,h=o.height/this._tmpBoundsOnModel.height,this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(o.x,o.y),this._tmpMatrix.scaleRelative(u,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(o.x,o.y),this._tmpMatrix.scaleRelative(u,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray()),a._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),a._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray());const m=a._clippingIdCount;for(let c=0;c<m;c++){const d=a._clippingIdList[c];t.getDrawableDynamicFlagVertexPositionsDidChange(d)&&(e.setIsCulling(t.getDrawableCulling(d)!=!1),this._clearedFrameBufferFlags.at(a._bufferIndex)||(this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this._clearedFrameBufferFlags.set(a._bufferIndex,!0)),e.setClippingContextBufferForMask(a),e.drawMeshWebGL(t,d))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,Ht),e.setClippingContextBufferForMask(null),this.gl.viewport(Z[0],Z[1],Z[2],Z[3])}}getColorBuffer(){return this._maskColorBuffers}getClippingMaskCount(){return this._clippingContextListForMask.getSize()}}class fs{constructor(t,e){this.frameNo=t,this.textures=e}}class ys extends Ps{constructor(t,e,i){super(e,i),this._owner=t}getClippingManager(){return this._owner}setGl(t){this._owner.setGL(t)}}class Jr{setGlEnable(t,e){e?this.gl.enable(t):this.gl.disable(t)}setGlEnableVertexAttribArray(t,e){e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t)}save(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._lastArrayBufferBinding=this.gl.getParameter(this.gl.ARRAY_BUFFER_BINDING),this._lastElementArrayBufferBinding=this.gl.getParameter(this.gl.ELEMENT_ARRAY_BUFFER_BINDING),this._lastProgram=this.gl.getParameter(this.gl.CURRENT_PROGRAM),this._lastActiveTexture=this.gl.getParameter(this.gl.ACTIVE_TEXTURE),this.gl.activeTexture(this.gl.TEXTURE1),this._lastTexture1Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this.gl.activeTexture(this.gl.TEXTURE0),this._lastTexture0Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this._lastVertexAttribArrayEnabled[0]=this.gl.getVertexAttrib(0,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[1]=this.gl.getVertexAttrib(1,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[2]=this.gl.getVertexAttrib(2,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[3]=this.gl.getVertexAttrib(3,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastScissorTest=this.gl.isEnabled(this.gl.SCISSOR_TEST),this._lastStencilTest=this.gl.isEnabled(this.gl.STENCIL_TEST),this._lastDepthTest=this.gl.isEnabled(this.gl.DEPTH_TEST),this._lastCullFace=this.gl.isEnabled(this.gl.CULL_FACE),this._lastBlend=this.gl.isEnabled(this.gl.BLEND),this._lastFrontFace=this.gl.getParameter(this.gl.FRONT_FACE),this._lastColorMask=this.gl.getParameter(this.gl.COLOR_WRITEMASK),this._lastBlending[0]=this.gl.getParameter(this.gl.BLEND_SRC_RGB),this._lastBlending[1]=this.gl.getParameter(this.gl.BLEND_DST_RGB),this._lastBlending[2]=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),this._lastBlending[3]=this.gl.getParameter(this.gl.BLEND_DST_ALPHA),this._lastFBO=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING),this._lastViewport=this.gl.getParameter(this.gl.VIEWPORT)}restore(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this.gl.useProgram(this._lastProgram),this.setGlEnableVertexAttribArray(0,this._lastVertexAttribArrayEnabled[0]),this.setGlEnableVertexAttribArray(1,this._lastVertexAttribArrayEnabled[1]),this.setGlEnableVertexAttribArray(2,this._lastVertexAttribArrayEnabled[2]),this.setGlEnableVertexAttribArray(3,this._lastVertexAttribArrayEnabled[3]),this.setGlEnable(this.gl.SCISSOR_TEST,this._lastScissorTest),this.setGlEnable(this.gl.STENCIL_TEST,this._lastStencilTest),this.setGlEnable(this.gl.DEPTH_TEST,this._lastDepthTest),this.setGlEnable(this.gl.CULL_FACE,this._lastCullFace),this.setGlEnable(this.gl.BLEND,this._lastBlend),this.gl.frontFace(this._lastFrontFace),this.gl.colorMask(this._lastColorMask[0],this._lastColorMask[1],this._lastColorMask[2],this._lastColorMask[3]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._lastArrayBufferBinding),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._lastElementArrayBufferBinding),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture1Binding2D),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture0Binding2D),this.gl.activeTexture(this._lastActiveTexture),this.gl.blendFuncSeparate(this._lastBlending[0],this._lastBlending[1],this._lastBlending[2],this._lastBlending[3])}setGl(t){this.gl=t}constructor(){this._lastVertexAttribArrayEnabled=new Array(4),this._lastColorMask=new Array(4),this._lastBlending=new Array(4),this._lastViewport=new Array(4)}}class we extends Jt{initialize(t,e=1){t.isUsingMasking()&&(this._clippingManager=new be,this._clippingManager.initialize(t,e)),this._sortedDrawableIndexList.resize(t.getDrawableCount(),0),super.initialize(t)}bindTexture(t,e){this._textures.setValue(t,e)}getBindedTextures(){return this._textures}setClippingMaskBufferSize(t){if(!this._model.isUsingMasking())return;const e=this._clippingManager.getRenderTextureCount();this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null,this._clippingManager=new be,this._clippingManager.setClippingMaskBufferSize(t),this._clippingManager.initialize(this.getModel(),e)}getClippingMaskBufferSize(){return this._model.isUsingMasking()?this._clippingManager.getClippingMaskBufferSize():-1}getRenderTextureCount(){return this._model.isUsingMasking()?this._clippingManager.getRenderTextureCount():-1}constructor(){super(),this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._rendererProfile=new Jr,this.firstDraw=!0,this._textures=new H,this._sortedDrawableIndexList=new x,this._bufferData={vertex:WebGLBuffer=null,uv:WebGLBuffer=null,index:WebGLBuffer=null},this._textures.prepareCapacity(32,!0)}release(){this._clippingManager&&(this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null),this.gl!=null&&(this.gl.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,this.gl.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,this.gl.deleteBuffer(this._bufferData.index),this._bufferData.index=null,this._bufferData=null,this._textures=null)}doDrawModel(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._clippingManager!=null&&(this.preDraw(),this.isUsingHighPrecisionMask()?this._clippingManager.setupMatrixForHighPrecision(this.getModel(),!1):this._clippingManager.setupClippingContext(this.getModel(),this)),this.preDraw();const t=this.getModel().getDrawableCount(),e=this.getModel().getDrawableRenderOrders();for(let i=0;i<t;++i){const s=e[i];this._sortedDrawableIndexList.set(s,i)}for(let i=0;i<t;++i){const s=this._sortedDrawableIndexList.at(i);if(!this.getModel().getDrawableDynamicFlagIsVisible(s))continue;const a=this._clippingManager!=null?this._clippingManager.getClippingContextListForDraw().at(s):null;if(a!=null&&this.isUsingHighPrecisionMask()){a._isUsing&&(this.gl.viewport(0,0,this._clippingManager.getClippingMaskBufferSize(),this._clippingManager.getClippingMaskBufferSize()),this.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a.getClippingManager().getMaskRenderTexture().at(a._bufferIndex)),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT));{const n=a._clippingIdCount;for(let o=0;o<n;o++){const l=a._clippingIdList[o];this._model.getDrawableDynamicFlagVertexPositionsDidChange(l)&&(this.setIsCulling(this._model.getDrawableCulling(l)!=!1),this.setClippingContextBufferForMask(a),this.drawMeshWebGL(this._model,l))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,Ht),this.setClippingContextBufferForMask(null),this.gl.viewport(Z[0],Z[1],Z[2],Z[3]),this.preDraw()}this.setClippingContextBufferForDraw(a),this.setIsCulling(this.getModel().getDrawableCulling(s)),this.drawMeshWebGL(this._model,s)}}drawMeshWebGL(t,e){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW),this.isGeneratingMask()?ot.getInstance().getShader(this.gl).setupShaderProgramForMask(this,t,e):ot.getInstance().getShader(this.gl).setupShaderProgramForDraw(this,t,e);{const i=t.getDrawableVertexIndexCount(e);this.gl.drawElements(this.gl.TRIANGLES,i,this.gl.UNSIGNED_SHORT,0)}this.gl.useProgram(null),this.setClippingContextBufferForDraw(null),this.setClippingContextBufferForMask(null)}saveProfile(){this._rendererProfile.save()}restoreProfile(){this._rendererProfile.restore()}static doStaticRelease(){ot.deleteInstance()}setRenderState(t,e){Ht=t,Z=e}preDraw(){if(this.firstDraw&&(this.firstDraw=!1),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.getAnisotropy()>0&&this._extension)for(let t=0;t<this._textures.getSize();++t)this.gl.bindTexture(this.gl.TEXTURE_2D,this._textures.getValue(t)),this.gl.texParameterf(this.gl.TEXTURE_2D,this._extension.TEXTURE_MAX_ANISOTROPY_EXT,this.getAnisotropy())}setClippingContextBufferForMask(t){this._clippingContextBufferForMask=t}getClippingContextBufferForMask(){return this._clippingContextBufferForMask}setClippingContextBufferForDraw(t){this._clippingContextBufferForDraw=t}getClippingContextBufferForDraw(){return this._clippingContextBufferForDraw}isGeneratingMask(){return this.getClippingContextBufferForMask()!=null}startUp(t){this.gl=t,this._clippingManager&&this._clippingManager.setGL(t),ot.getInstance().setGlContext(t),this._rendererProfile.setGl(t),this._extension=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")}}Jt.staticRelease=()=>{we.doStaticRelease()};var bi;(r=>{r.CubismClippingContext=ys,r.CubismClippingManager_WebGL=be,r.CubismRenderTextureResource=fs,r.CubismRenderer_WebGL=we})(bi||(bi={}));class $r{constructor(t=!1,e=!1){this.isOverridden=t,this.isParameterRepeated=e}}class Pi{constructor(t=!1,e=new k){this.isOverridden=t,this.color=e}get isOverwritten(){return this.isOverridden}}class vi{constructor(t=!1,e=new k){this.isOverridden=t,this.color=e}get isOverwritten(){return this.isOverridden}}class Kr{constructor(t=!1,e=!1){this.isOverridden=t,this.isCulling=e}get isOverwritten(){return this.isOverridden}}class Cs{update(){this._model.update(),this._model.drawables.resetDynamicFlags()}getPixelsPerUnit(){return this._model==null?0:this._model.canvasinfo.PixelsPerUnit}getCanvasWidth(){return this._model==null?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}getCanvasHeight(){return this._model==null?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}saveParameters(){const t=this._model.parameters.count,e=this._savedParameters.getSize();for(let i=0;i<t;++i)i<e?this._savedParameters.set(i,this._parameterValues[i]):this._savedParameters.pushBack(this._parameterValues[i])}getMultiplyColor(t){return this.getOverrideFlagForModelMultiplyColors()||this.getOverrideFlagForDrawableMultiplyColors(t)?this._userMultiplyColors.at(t).color:this.getDrawableMultiplyColor(t)}getScreenColor(t){return this.getOverrideFlagForModelScreenColors()||this.getOverrideFlagForDrawableScreenColors(t)?this._userScreenColors.at(t).color:this.getDrawableScreenColor(t)}setMultiplyColorByTextureColor(t,e){this.setMultiplyColorByRGBA(t,e.r,e.g,e.b,e.a)}setMultiplyColorByRGBA(t,e,i,s,a=1){this._userMultiplyColors.at(t).color.r=e,this._userMultiplyColors.at(t).color.g=i,this._userMultiplyColors.at(t).color.b=s,this._userMultiplyColors.at(t).color.a=a}setScreenColorByTextureColor(t,e){this.setScreenColorByRGBA(t,e.r,e.g,e.b,e.a)}setScreenColorByRGBA(t,e,i,s,a=1){this._userScreenColors.at(t).color.r=e,this._userScreenColors.at(t).color.g=i,this._userScreenColors.at(t).color.b=s,this._userScreenColors.at(t).color.a=a}getPartMultiplyColor(t){return this._userPartMultiplyColors.at(t).color}getPartScreenColor(t){return this._userPartScreenColors.at(t).color}setPartColor(t,e,i,s,a,n,o){if(n.at(t).color.r=e,n.at(t).color.g=i,n.at(t).color.b=s,n.at(t).color.a=a,n.at(t).isOverridden)for(let l=0;l<this._partChildDrawables.at(t).getSize();++l){const u=this._partChildDrawables.at(t).at(l);o.at(u).color.r=e,o.at(u).color.g=i,o.at(u).color.b=s,o.at(u).color.a=a}}setPartMultiplyColorByTextureColor(t,e){this.setPartMultiplyColorByRGBA(t,e.r,e.g,e.b,e.a)}setPartMultiplyColorByRGBA(t,e,i,s,a){this.setPartColor(t,e,i,s,a,this._userPartMultiplyColors,this._userMultiplyColors)}setPartScreenColorByTextureColor(t,e){this.setPartScreenColorByRGBA(t,e.r,e.g,e.b,e.a)}setPartScreenColorByRGBA(t,e,i,s,a){this.setPartColor(t,e,i,s,a,this._userPartScreenColors,this._userScreenColors)}getOverrideFlagForModelParameterRepeat(){return this._isOverriddenParameterRepeat}setOverrideFlagForModelParameterRepeat(t){this._isOverriddenParameterRepeat=t}getOverrideFlagForParameterRepeat(t){return this._userParameterRepeatDataList.at(t).isOverridden}setOverrideFlagForParameterRepeat(t,e){this._userParameterRepeatDataList.at(t).isOverridden=e}getRepeatFlagForParameterRepeat(t){return this._userParameterRepeatDataList.at(t).isParameterRepeated}setRepeatFlagForParameterRepeat(t,e){this._userParameterRepeatDataList.at(t).isParameterRepeated=e}getOverwriteFlagForModelMultiplyColors(){return B("getOverwriteFlagForModelMultiplyColors() is a deprecated function. Please use getOverrideFlagForModelMultiplyColors()."),this.getOverrideFlagForModelMultiplyColors()}getOverrideFlagForModelMultiplyColors(){return this._isOverriddenModelMultiplyColors}getOverwriteFlagForModelScreenColors(){return B("getOverwriteFlagForModelScreenColors() is a deprecated function. Please use getOverrideFlagForModelScreenColors()."),this.getOverrideFlagForModelScreenColors()}getOverrideFlagForModelScreenColors(){return this._isOverriddenModelScreenColors}setOverwriteFlagForModelMultiplyColors(t){B("setOverwriteFlagForModelMultiplyColors(value: boolean) is a deprecated function. Please use setOverrideFlagForModelMultiplyColors(value: boolean)."),this.setOverrideFlagForModelMultiplyColors(t)}setOverrideFlagForModelMultiplyColors(t){this._isOverriddenModelMultiplyColors=t}setOverwriteFlagForModelScreenColors(t){B("setOverwriteFlagForModelScreenColors(value: boolean) is a deprecated function. Please use setOverrideFlagForModelScreenColors(value: boolean)."),this.setOverrideFlagForModelScreenColors(t)}setOverrideFlagForModelScreenColors(t){this._isOverriddenModelScreenColors=t}getOverwriteFlagForDrawableMultiplyColors(t){return B("getOverwriteFlagForDrawableMultiplyColors(drawableindex: number) is a deprecated function. Please use getOverrideFlagForDrawableMultiplyColors(drawableindex: number)."),this.getOverrideFlagForDrawableMultiplyColors(t)}getOverrideFlagForDrawableMultiplyColors(t){return this._userMultiplyColors.at(t).isOverridden}getOverwriteFlagForDrawableScreenColors(t){return B("getOverwriteFlagForDrawableScreenColors(drawableindex: number) is a deprecated function. Please use getOverrideFlagForDrawableScreenColors(drawableindex: number)."),this.getOverrideFlagForDrawableScreenColors(t)}getOverrideFlagForDrawableScreenColors(t){return this._userScreenColors.at(t).isOverridden}setOverwriteFlagForDrawableMultiplyColors(t,e){B("setOverwriteFlagForDrawableMultiplyColors(drawableindex: number, value: boolean) is a deprecated function. Please use setOverrideFlagForDrawableMultiplyColors(drawableindex: number, value: boolean)."),this.setOverrideFlagForDrawableMultiplyColors(t,e)}setOverrideFlagForDrawableMultiplyColors(t,e){this._userMultiplyColors.at(t).isOverridden=e}setOverwriteFlagForDrawableScreenColors(t,e){B("setOverwriteFlagForDrawableScreenColors(drawableindex: number, value: boolean) is a deprecated function. Please use setOverrideFlagForDrawableScreenColors(drawableindex: number, value: boolean)."),this.setOverrideFlagForDrawableScreenColors(t,e)}setOverrideFlagForDrawableScreenColors(t,e){this._userScreenColors.at(t).isOverridden=e}getOverwriteColorForPartMultiplyColors(t){return B("getOverwriteColorForPartMultiplyColors(partIndex: number) is a deprecated function. Please use getOverrideColorForPartMultiplyColors(partIndex: number)."),this.getOverrideColorForPartMultiplyColors(t)}getOverrideColorForPartMultiplyColors(t){return this._userPartMultiplyColors.at(t).isOverridden}getOverwriteColorForPartScreenColors(t){return B("getOverwriteColorForPartScreenColors(partIndex: number) is a deprecated function. Please use getOverrideColorForPartScreenColors(partIndex: number)."),this.getOverrideColorForPartScreenColors(t)}getOverrideColorForPartScreenColors(t){return this._userPartScreenColors.at(t).isOverridden}setOverwriteColorForPartColors(t,e,i,s){B("setOverwriteColorForPartColors(partIndex: number, value: boolean, partColors: csmVector<PartColorData>, drawableColors: csmVector<DrawableColorData>) is a deprecated function. Please use setOverrideColorForPartColors(partIndex: number, value: boolean, partColors: csmVector<PartColorData>, drawableColors: csmVector<DrawableColorData>)."),this.setOverrideColorForPartColors(t,e,i,s)}setOverrideColorForPartColors(t,e,i,s){i.at(t).isOverridden=e;for(let a=0;a<this._partChildDrawables.at(t).getSize();++a){const n=this._partChildDrawables.at(t).at(a);s.at(n).isOverridden=e,e&&(s.at(n).color.r=i.at(t).color.r,s.at(n).color.g=i.at(t).color.g,s.at(n).color.b=i.at(t).color.b,s.at(n).color.a=i.at(t).color.a)}}setOverwriteColorForPartMultiplyColors(t,e){B("setOverwriteColorForPartMultiplyColors(partIndex: number, value: boolean) is a deprecated function. Please use setOverrideColorForPartMultiplyColors(partIndex: number, value: boolean)."),this.setOverrideColorForPartMultiplyColors(t,e)}setOverrideColorForPartMultiplyColors(t,e){this._userPartMultiplyColors.at(t).isOverridden=e,this.setOverrideColorForPartColors(t,e,this._userPartMultiplyColors,this._userMultiplyColors)}setOverwriteColorForPartScreenColors(t,e){B("setOverwriteColorForPartScreenColors(partIndex: number, value: boolean) is a deprecated function. Please use setOverrideColorForPartScreenColors(partIndex: number, value: boolean)."),this.setOverrideColorForPartScreenColors(t,e)}setOverrideColorForPartScreenColors(t,e){this._userPartScreenColors.at(t).isOverridden=e,this.setOverrideColorForPartColors(t,e,this._userPartScreenColors,this._userScreenColors)}getDrawableCulling(t){if(this.getOverrideFlagForModelCullings()||this.getOverrideFlagForDrawableCullings(t))return this._userCullings.at(t).isCulling;const e=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(e[t])}setDrawableCulling(t,e){this._userCullings.at(t).isCulling=e}getOverwriteFlagForModelCullings(){return B("getOverwriteFlagForModelCullings() is a deprecated function. Please use getOverrideFlagForModelCullings()."),this.getOverrideFlagForModelCullings()}getOverrideFlagForModelCullings(){return this._isOverriddenCullings}setOverwriteFlagForModelCullings(t){B("setOverwriteFlagForModelCullings(isOverriddenCullings: boolean) is a deprecated function. Please use setOverrideFlagForModelCullings(isOverriddenCullings: boolean)."),this.setOverrideFlagForModelCullings(t)}setOverrideFlagForModelCullings(t){this._isOverriddenCullings=t}getOverwriteFlagForDrawableCullings(t){return B("getOverwriteFlagForDrawableCullings(drawableIndex: number) is a deprecated function. Please use getOverrideFlagForDrawableCullings(drawableIndex: number)."),this.getOverrideFlagForDrawableCullings(t)}getOverrideFlagForDrawableCullings(t){return this._userCullings.at(t).isOverridden}setOverwriteFlagForDrawableCullings(t,e){B("setOverwriteFlagForDrawableCullings(drawableIndex: number, isOverriddenCullings: boolean) is a deprecated function. Please use setOverrideFlagForDrawableCullings(drawableIndex: number, isOverriddenCullings: boolean)."),this.setOverrideFlagForDrawableCullings(t,e)}setOverrideFlagForDrawableCullings(t,e){this._userCullings.at(t).isOverridden=e}getModelOapcity(){return this._modelOpacity}setModelOapcity(t){this._modelOpacity=t}getModel(){return this._model}getPartIndex(t){let e;const i=this._model.parts.count;for(e=0;e<i;++e)if(t==this._partIds.at(e))return e;return this._notExistPartId.isExist(t)?this._notExistPartId.getValue(t):(e=i+this._notExistPartId.getSize(),this._notExistPartId.setValue(t,e),this._notExistPartOpacities.appendKey(e),e)}getPartId(t){const e=this._model.parts.ids[t];return I.getIdManager().getId(e)}getPartCount(){return this._model.parts.count}getPartParentPartIndices(){return this._model.parts.parentIndices}setPartOpacityByIndex(t,e){if(this._notExistPartOpacities.isExist(t)){this._notExistPartOpacities.setValue(t,e);return}A(0<=t&&t<this.getPartCount()),this._partOpacities[t]=e}setPartOpacityById(t,e){const i=this.getPartIndex(t);i<0||this.setPartOpacityByIndex(i,e)}getPartOpacityByIndex(t){return this._notExistPartOpacities.isExist(t)?this._notExistPartOpacities.getValue(t):(A(0<=t&&t<this.getPartCount()),this._partOpacities[t])}getPartOpacityById(t){const e=this.getPartIndex(t);return e<0?0:this.getPartOpacityByIndex(e)}getParameterIndex(t){let e;const i=this._model.parameters.count;for(e=0;e<i;++e)if(t==this._parameterIds.at(e))return e;return this._notExistParameterId.isExist(t)?this._notExistParameterId.getValue(t):(e=this._model.parameters.count+this._notExistParameterId.getSize(),this._notExistParameterId.setValue(t,e),this._notExistParameterValues.appendKey(e),e)}getParameterCount(){return this._model.parameters.count}getParameterType(t){return this._model.parameters.types[t]}getParameterMaximumValue(t){return this._model.parameters.maximumValues[t]}getParameterMinimumValue(t){return this._model.parameters.minimumValues[t]}getParameterDefaultValue(t){return this._model.parameters.defaultValues[t]}getParameterId(t){return I.getIdManager().getId(this._model.parameters.ids[t])}getParameterValueByIndex(t){return this._notExistParameterValues.isExist(t)?this._notExistParameterValues.getValue(t):(A(0<=t&&t<this.getParameterCount()),this._parameterValues[t])}getParameterValueById(t){const e=this.getParameterIndex(t);return this.getParameterValueByIndex(e)}setParameterValueByIndex(t,e,i=1){if(this._notExistParameterValues.isExist(t)){this._notExistParameterValues.setValue(t,i==1?e:this._notExistParameterValues.getValue(t)*(1-i)+e*i);return}A(0<=t&&t<this.getParameterCount()),this.isRepeat(t)?e=this.getParameterRepeatValue(t,e):e=this.getParameterClampValue(t,e),this._parameterValues[t]=i==1?e:this._parameterValues[t]=this._parameterValues[t]*(1-i)+e*i}setParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.setParameterValueByIndex(s,e,i)}addParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)+e*i)}addParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.addParameterValueByIndex(s,e,i)}isRepeat(t){if(this._notExistParameterValues.isExist(t))return!1;A(0<=t&&t<this.getParameterCount());let e;return this._isOverriddenParameterRepeat||this._userParameterRepeatDataList.at(t).isOverridden?e=this._userParameterRepeatDataList.at(t).isParameterRepeated:e=this._model.parameters.repeats[t]!=0,e}getParameterRepeatValue(t,e){if(this._notExistParameterValues.isExist(t))return e;A(0<=t&&t<this.getParameterCount());const i=this._model.parameters.maximumValues[t],s=this._model.parameters.minimumValues[t],a=i-s;if(i<e){const n=M.mod(e-i,a);Number.isNaN(n)?e=i:e=s+n}if(e<s){const n=M.mod(s-e,a);Number.isNaN(n)?e=s:e=i-n}return e}getParameterClampValue(t,e){if(this._notExistParameterValues.isExist(t))return e;A(0<=t&&t<this.getParameterCount());const i=this._model.parameters.maximumValues[t],s=this._model.parameters.minimumValues[t];return M.clamp(e,s,i)}getParameterRepeats(t){return this._model.parameters.repeats[t]!=0}multiplyParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.multiplyParameterValueByIndex(s,e,i)}multiplyParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)*(1+(e-1)*i))}getDrawableIndex(t){const e=this._model.drawables.count;for(let i=0;i<e;++i)if(this._drawableIds.at(i)==t)return i;return-1}getDrawableCount(){return this._model.drawables.count}getDrawableId(t){const e=this._model.drawables.ids;return I.getIdManager().getId(e[t])}getDrawableRenderOrders(){return this._model.drawables.renderOrders}getDrawableTextureIndices(t){return this.getDrawableTextureIndex(t)}getDrawableTextureIndex(t){return this._model.drawables.textureIndices[t]}getDrawableDynamicFlagVertexPositionsDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(e[t])}getDrawableVertexIndexCount(t){return this._model.drawables.indexCounts[t]}getDrawableVertexCount(t){return this._model.drawables.vertexCounts[t]}getDrawableVertices(t){return this.getDrawableVertexPositions(t)}getDrawableVertexIndices(t){return this._model.drawables.indices[t]}getDrawableVertexPositions(t){return this._model.drawables.vertexPositions[t]}getDrawableVertexUvs(t){return this._model.drawables.vertexUvs[t]}getDrawableOpacity(t){return this._model.drawables.opacities[t]}getDrawableMultiplyColor(t){const e=this._model.drawables.multiplyColors,i=t*4,s=new k;return s.r=e[i],s.g=e[i+1],s.b=e[i+2],s.a=e[i+3],s}getDrawableScreenColor(t){const e=this._model.drawables.screenColors,i=t*4,s=new k;return s.r=e[i],s.g=e[i+1],s.b=e[i+2],s.a=e[i+3],s}getDrawableParentPartIndex(t){return this._model.drawables.parentPartIndices[t]}getDrawableBlendMode(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(e[t])?it.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(e[t])?it.CubismBlendMode_Multiplicative:it.CubismBlendMode_Normal}getDrawableInvertedMaskBit(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(e[t])}getDrawableMasks(){return this._model.drawables.masks}getDrawableMaskCounts(){return this._model.drawables.maskCounts}isUsingMasking(){for(let t=0;t<this._model.drawables.count;++t)if(!(this._model.drawables.maskCounts[t]<=0))return!0;return!1}getDrawableDynamicFlagIsVisible(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(e[t])}getDrawableDynamicFlagVisibilityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(e[t])}getDrawableDynamicFlagOpacityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(e[t])}getDrawableDynamicFlagRenderOrderDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(e[t])}getDrawableDynamicFlagBlendColorDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasBlendColorDidChangeBit(e[t])}loadParameters(){let t=this._model.parameters.count;const e=this._savedParameters.getSize();t>e&&(t=e);for(let i=0;i<t;++i)this._parameterValues[i]=this._savedParameters.at(i)}initialize(){A(this._model),this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;{const e=this._model.parameters.ids,i=this._model.parameters.count;this._parameterIds.prepareCapacity(i),this._userParameterRepeatDataList.prepareCapacity(i);for(let s=0;s<i;++s)this._parameterIds.pushBack(I.getIdManager().getId(e[s])),this._userParameterRepeatDataList.pushBack(new $r(!1,!1))}const t=this._model.parts.count;{const e=this._model.parts.ids;this._partIds.prepareCapacity(t);for(let i=0;i<t;++i)this._partIds.pushBack(I.getIdManager().getId(e[i]));this._userPartMultiplyColors.prepareCapacity(t),this._userPartScreenColors.prepareCapacity(t),this._partChildDrawables.prepareCapacity(t)}{const e=this._model.drawables.ids,i=this._model.drawables.count;this._userMultiplyColors.prepareCapacity(i),this._userScreenColors.prepareCapacity(i),this._userCullings.prepareCapacity(i);const s=new Kr(!1,!1);for(let a=0;a<t;++a){const n=new k(1,1,1,1),o=new k(0,0,0,1),l=new vi(!1,n),u=new vi(!1,o);this._userPartMultiplyColors.pushBack(l),this._userPartScreenColors.pushBack(u),this._partChildDrawables.pushBack(new x),this._partChildDrawables.at(a).prepareCapacity(i)}for(let a=0;a<i;++a){const n=new k(1,1,1,1),o=new k(0,0,0,1),l=new Pi(!1,n),u=new Pi(!1,o);this._drawableIds.pushBack(I.getIdManager().getId(e[a])),this._userMultiplyColors.pushBack(l),this._userScreenColors.pushBack(u),this._userCullings.pushBack(s);const h=this.getDrawableParentPartIndex(a);h>=0&&this._partChildDrawables.at(h).pushBack(a)}}}constructor(t){this._model=t,this._parameterValues=null,this._parameterMaximumValues=null,this._parameterMinimumValues=null,this._partOpacities=null,this._savedParameters=new x,this._parameterIds=new x,this._drawableIds=new x,this._partIds=new x,this._isOverriddenParameterRepeat=!0,this._isOverriddenModelMultiplyColors=!1,this._isOverriddenModelScreenColors=!1,this._isOverriddenCullings=!1,this._modelOpacity=1,this._userParameterRepeatDataList=new x,this._userMultiplyColors=new x,this._userScreenColors=new x,this._userCullings=new x,this._userPartMultiplyColors=new x,this._userPartScreenColors=new x,this._partChildDrawables=new x,this._notExistPartId=new H,this._notExistParameterId=new H,this._notExistParameterValues=new H,this._notExistPartOpacities=new H}release(){this._model.release(),this._model=null}}var Bi;(r=>{r.CubismModel=Cs})(Bi||(Bi={}));class Zt{static create(t,e){let i=null;if(e&&!this.hasMocConsistency(t))return w("Inconsistent MOC3."),i;const s=Live2DCubismCore.Moc.fromArrayBuffer(t);return s&&(i=new Zt(s),i._mocVersion=Live2DCubismCore.Version.csmGetMocVersion(s,t)),i}static delete(t){t._moc._release(),t._moc=null,t=null}createModel(){let t=null;const e=Live2DCubismCore.Model.fromMoc(this._moc);return e&&(t=new Cs(e),t.initialize(),++this._modelCount),t}deleteModel(t){t!=null&&(t.release(),t=null,--this._modelCount)}constructor(t){this._moc=t,this._modelCount=0,this._mocVersion=0}release(){A(this._modelCount==0),this._moc._release(),this._moc=null}getLatestMocVersion(){return Live2DCubismCore.Version.csmGetLatestMocVersion()}getMocVersion(){return this._mocVersion}static hasMocConsistency(t){return Live2DCubismCore.Moc.prototype.hasMocConsistency(t)===1}}var Vi;(r=>{r.CubismMoc=Zt})(Vi||(Vi={}));const Ii="Meta",Zr="UserDataCount",Qr="TotalUserDataSize",oe="UserData",ta="Target",ea="Id",ia="Value";class xs{constructor(t,e){this._json=D.create(t,e)}release(){D.delete(this._json)}getUserDataCount(){return this._json.getRoot().getValueByString(Ii).getValueByString(Zr).toInt()}getTotalUserDataSize(){return this._json.getRoot().getValueByString(Ii).getValueByString(Qr).toInt()}getUserDataTargetType(t){return this._json.getRoot().getValueByString(oe).getValueByIndex(t).getValueByString(ta).getRawString()}getUserDataId(t){return I.getIdManager().getId(this._json.getRoot().getValueByString(oe).getValueByIndex(t).getValueByString(ea).getRawString())}getUserDataValue(t){return this._json.getRoot().getValueByString(oe).getValueByIndex(t).getValueByString(ia).getRawString()}}var Fi;(r=>{r.CubismModelUserDataJson=xs})(Fi||(Fi={}));const sa="ArtMesh";class Ss{}class Dt{static create(t,e){const i=new Dt;return i.parseUserData(t,e),i}static delete(t){t!=null&&(t.release(),t=null)}getArtMeshUserDatas(){return this._artMeshUserDataNode}parseUserData(t,e){let i=new xs(t,e);if(!i){i.release(),i=void 0;return}const s=I.getIdManager().getId(sa),a=i.getUserDataCount();for(let n=0;n<a;n++){const o=new Ss;o.targetId=i.getUserDataId(n),o.targetType=I.getIdManager().getId(i.getUserDataTargetType(n)),o.value=new X(i.getUserDataValue(n)),this._userDataNodes.pushBack(o),o.targetType==s&&this._artMeshUserDataNode.pushBack(o)}i.release(),i=void 0}constructor(){this._userDataNodes=new x,this._artMeshUserDataNode=new x}release(){for(let t=0;t<this._userDataNodes.getSize();++t)this._userDataNodes.set(t,null);this._userDataNodes=null}}var wi;(r=>{r.CubismModelUserData=Dt,r.CubismModelUserDataNode=Ss})(wi||(wi={}));let ra=class Ms{isInitialized(){return this._initialized}setInitialized(t){this._initialized=t}isUpdating(){return this._updating}setUpdating(t){this._updating=t}setDragging(t,e){this._dragManager.set(t,e)}setAcceleration(t,e,i){this._accelerationX=t,this._accelerationY=e,this._accelerationZ=i}getModelMatrix(){return this._modelMatrix}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}loadModel(t,e=!1){if(this._moc=Zt.create(t,e),this._moc==null){w("Failed to CubismMoc.create().");return}if(this._model=this._moc.createModel(),this._model==null){w("Failed to CreateModel().");return}this._model.saveParameters(),this._modelMatrix=new zi(this._model.getCanvasWidth(),this._model.getCanvasHeight())}loadMotion(t,e,i,s,a,n,o,l,u=!1){if(t==null||e==0)return w("Failed to loadMotion()."),null;const h=ss.create(t,e,s,a,u);if(h==null)return w("Failed to create motion from buffer in LoadMotion()"),null;if(n){const g=n.getMotionFadeInTimeValue(o,l);g>=0&&h.setFadeInTime(g);const m=n.getMotionFadeOutTimeValue(o,l);m>=0&&h.setFadeOutTime(m)}return h}loadExpression(t,e,i){return t==null||e==0?(w("Failed to loadExpression()."),null):pt.create(t,e)}loadPose(t,e){if(t==null||e==0){w("Failed to loadPose().");return}this._pose=Tt.create(t,e)}loadUserData(t,e){if(t==null||e==0){w("Failed to loadUserData().");return}this._modelUserData=Dt.create(t,e)}loadPhysics(t,e){if(t==null||e==0){w("Failed to loadPhysics().");return}this._physics=Se.create(t,e)}isHit(t,e,i){const s=this._model.getDrawableIndex(t);if(s<0)return!1;const a=this._model.getDrawableVertexCount(s),n=this._model.getDrawableVertices(s);let o=n[0],l=n[0],u=n[1],h=n[1];for(let c=1;c<a;++c){const d=n[tt.vertexOffset+c*tt.vertexStep],p=n[tt.vertexOffset+c*tt.vertexStep+1];d<o&&(o=d),d>l&&(l=d),p<u&&(u=p),p>h&&(h=p)}const g=this._modelMatrix.invertTransformX(e),m=this._modelMatrix.invertTransformY(i);return o<=g&&g<=l&&u<=m&&m<=h}getModel(){return this._model}getRenderer(){return this._renderer}createRenderer(t=1){this._renderer&&this.deleteRenderer(),this._renderer=new we,this._renderer.initialize(this._model,t)}deleteRenderer(){this._renderer!=null&&(this._renderer.release(),this._renderer=null)}motionEventFired(t){j("{0}",t.s)}static cubismDefaultMotionEventCallback(t,e,i){const s=i;s?.motionEventFired(e)}constructor(){this._moc=null,this._model=null,this._motionManager=null,this._expressionManager=null,this._eyeBlink=null,this._breath=null,this._modelMatrix=null,this._pose=null,this._dragManager=null,this._physics=null,this._modelUserData=null,this._initialized=!1,this._updating=!1,this._opacity=1,this._lipsync=!0,this._lastLipSyncValue=0,this._dragX=0,this._dragY=0,this._accelerationX=0,this._accelerationY=0,this._accelerationZ=0,this._mocConsistency=!1,this._debugMode=!1,this._renderer=null,this._motionManager=new as,this._motionManager.setEventCallback(Ms.cubismDefaultMotionEventCallback,this),this._expressionManager=new qi,this._dragManager=new ji}release(){this._motionManager!=null&&(this._motionManager.release(),this._motionManager=null),this._expressionManager!=null&&(this._expressionManager.release(),this._expressionManager=null),this._moc!=null&&(this._moc.deleteModel(this._model),this._moc.release(),this._moc=null),this._modelMatrix=null,Tt.delete(this._pose),Ui.delete(this._eyeBlink),$t.delete(this._breath),this._dragManager=null,Se.delete(this._physics),Dt.delete(this._modelUserData),this.deleteRenderer()}};var Pe;(r=>{r.CubismUserModel=ra})(Pe||(Pe={}));const nt=I;class Sa extends ce.ICubismModelSetting{}class aa extends de.CubismModelSettingJson{}class na extends ge.CubismMatrix44{}class oa extends Pe.CubismUserModel{}class Ma extends me.ACubismMotion{}class ba extends fe.CubismMotion{}class Pa extends pe.CubismExpressionMotion{}class va extends ye.CubismMotionManager{}class Ba extends Me.CubismPhysics{}class la extends _e.CubismEyeBlink{}class zt extends he.csmVector{}class ua extends oa{motionResources;expressionResources;lipSyncParamIds=new zt;eyeBlinkParamIds=new zt;constructor(){super(),this.motionResources={},this.expressionResources={},this.lipSyncParamIds=new zt,this.eyeBlinkParamIds=new zt,this._lipsync=!1}setEyeBlink(t){this._eyeBlink=t}addEyeBlinkParameterId(t){this.eyeBlinkParamIds.pushBack(t)}addLipSyncParameterId(t){this.lipSyncParamIds.pushBack(t)}addMotion(t,e,i=1,s=1){const a=this.loadMotion(t,t.byteLength,e);return i>0&&a.setFadeInTime(i),s>0&&a.setFadeOutTime(s),a.setEffectIds(this.eyeBlinkParamIds,this.lipSyncParamIds),this.motionResources[e]=a,e}addExpression(t,e,i=1,s=1){const a=this.loadExpression(t,t.byteLength,e);return i>0&&a.setFadeInTime(i),s>0&&a.setFadeOutTime(s),this.expressionResources[e]=a,e}get motionNames(){return Object.keys(this.motionResources)}get isMotionFinished(){return this._motionManager.isFinished()}startMotionByName(t){const e=this.motionResources[t];e&&this._motionManager.startMotionPriority(e,!1,0)}startExpressionByName(t){const e=this.expressionResources[t];e&&this._expressionManager.startMotionPriority(e,!1,1)}update(t){this.getModel().loadParameters();const e=this._motionManager.updateMotion(this.getModel(),t),i=this._expressionManager.updateMotion(this.getModel(),t);this.getModel().saveParameters(),!e&&!i&&this._eyeBlink!=null&&this._eyeBlink.updateParameters(this._model,t),this._pose!==null&&this._pose.updateParameters(this._model,0),this._physics!=null&&this._physics.evaluate(this._model,t),this._model.update()}}const ha={autoBlink:!0,x:0,y:0,scale:1};let Ti=!1;class ga{canvas;model=new ua;point=new Di;constructor(t){this.canvas=t}async init(t,e,i={}){const s=this.canvas.getContext("webgl");if(s===null)throw new Error("WebGL");s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL);const a=Object.assign({},ha,i),n=s.getParameter(s.FRAMEBUFFER_BINDING);Ti||(nt.startUp(),nt.initialize(),Ti=!0);const o=new aa(t,t.byteLength),{moc3:l,textures:u,physics:h,expressions:g,motions:m}=e;this.model.loadModel(l),this.model.createRenderer();let c=0;for(const V of u){const R=await ca(V,s);this.model.getRenderer().bindTexture(c,R),c++}this.model.getRenderer().setIsPremultipliedAlpha(!0),this.model.getRenderer().startUp(s),a.autoBlink&&this.model.setEyeBlink(la.create(o));for(let V=0,R=o.getEyeBlinkParameterCount();V<R;V++)this.model.addEyeBlinkParameterId(o.getEyeBlinkParameterId(V));for(let V=0,R=o.getLipSyncParameterCount();V<R;V++)this.model.addLipSyncParameterId(o.getLipSyncParameterId(V));this.model.loadPhysics(h,h.byteLength);for(const[V,R]of g)this.model.addExpression(R,V);for(const[V,R]of m)this.model.addMotion(R,V);const d=Object.assign({x:0,y:0,z:1},{x:a.x,y:a.y,z:a.scale}),p=new na,_=()=>{this.canvas.width=this.canvas.clientWidth*devicePixelRatio,this.canvas.height=this.canvas.clientHeight*devicePixelRatio;const V=this.model.getModelMatrix();V.bottom(0),V.centerY(-1),V.translateY(-1),p.loadIdentity(),1<this.canvas.height/this.canvas.width?V.scale(1,this.canvas.width/this.canvas.height):V.scale(this.canvas.height/this.canvas.width,1),V.translateRelative(d.x,d.y),p.multiplyByMatrix(V);const Mt=d.z;p.scaleRelative(Mt,Mt),this.model.getRenderer().setMvpMatrix(p)};_();const S=[0,0,this.canvas.width,this.canvas.height];let b=Date.now();const f=this.model.getModel(),y=nt.getIdManager(),P=()=>{const V=Date.now(),R=(V-b)/1e3;f.setParameterValueById(y.getId("ParamAngleX"),this.point.angleX,.5),f.setParameterValueById(y.getId("ParamAngleY"),this.point.angleY,.5),f.setParameterValueById(y.getId("ParamAngleZ"),this.point.angleZ,.5),f.setParameterValueById(y.getId("ParamEyeBallX"),this.point.angleEyeX,.5),f.setParameterValueById(y.getId("ParamEyeBallY"),this.point.angleEyeY,.5),f.setParameterValueById(y.getId("ParamBodyAngleZ"),this.point.angleZ/2,.05),f.saveParameters(),this.model.update(R),S[2]=this.canvas.width,S[3]=this.canvas.height,this.model.getRenderer().setRenderState(n,S),this.model.getRenderer().drawModel(),b=V,requestAnimationFrame(P)};window.addEventListener("resize",()=>{_(),P()}),P();const v=["akubi","akubi","swing","AiArt"],T=()=>{setTimeout(()=>{this.model.isMotionFinished&&this.model.startMotionByName(v[Math.floor(Math.random()*v.length)]),T()},1e3*10+Math.random()*1e3*80)};T();const G=()=>{setTimeout(()=>{this.model.startMotionByName("mimi"),G()},1e3*10+Math.random()*1e3*30)};G()}updatePoint(t){Object.assign(this.point,t)}click(t){const e=this.canvas.getBoundingClientRect(),i=e.left+e.width/2,s=e.top+e.height/2,a=(t.clientX-i)/(e.width/2),n=(t.clientY-s)/(e.height/2);this.model.isHit(nt.getIdManager().getId("HitArea"),a,n)?this.model.startMotionByName("mimi"):this.model.isHit(nt.getIdManager().getId("HitArea2"),a,n)?this.model.startMotionByName("mimi"):this.model.isHit(nt.getIdManager().getId("HitArea_Body"),a,n)?this.model.startMotionByName("mimi"):this.model.isHit(nt.getIdManager().getId("HitArea_Head"),a,n)}}async function ca(r,t){return new Promise(e=>{const i=URL.createObjectURL(r),s=new Image;s.onload=()=>{const a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.generateMipmap(t.TEXTURE_2D),URL.revokeObjectURL(i),e(a)},s.addEventListener("error",()=>{console.error("image load error")}),s.src=i})}function da(r,t,e,i){return Math.sqrt(Math.pow(e-r,2)+Math.pow(i-t,2))}function _a(r,t,e,i){return Math.atan2(i-t,e-r)}const Ri="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js",N="./misskey/live2d/ai/web/",dt={moc3:N+"ai.moc3",model3:N+"ai.model3.json",physics3:N+"ai.physics3.json",textures:[N+"ai.4096/texture_00.png"],expressions:{smile:N+"expressions/exp_01.exp3.json",surprise:N+"expressions/exp_02.exp3.json",happy:N+"expressions/exp_06.exp3.json",jitome:N+"expressions/exp_11.exp3.json",gurugurume:N+"expressions/exp_20.exp3.json"},motions:{swing:N+"motions/mtn_03.motion3.json",akubi:N+"motions/mtn_04.motion3.json",mimi:N+"motions/mtn_05.motion3.json",AiArt:N+"motions/AiArt.motion3.json"}};let Ei=!1;function ma(r,t){return new Promise((e,i)=>{const s=document.head.querySelector(`script[src="${Ri}"]`);if(s)Ei?le(r,t).then(a=>{e(a)}):s.addEventListener("load",()=>{le(r,t).then(a=>{e(a)})});else{const a=document.createElement("script");a.setAttribute("src",Ri),document.head.appendChild(a),a.addEventListener("load",()=>{Ei=!0,le(r,t).then(n=>{e(n)})})}})}async function le(r,t){try{const[e,i,s,a,n,o]=await Promise.all([fetch(dt.model3).then(g=>g.arrayBuffer()),fetch(dt.moc3).then(g=>g.arrayBuffer()),fetch(dt.physics3).then(g=>g.arrayBuffer()),Promise.all(dt.textures.map(g=>fetch(g).then(m=>m.blob()))),Promise.all(Object.entries(dt.expressions).map(([g,m])=>fetch(m).then(c=>c.arrayBuffer()).then(c=>[g,c]))),Promise.all(Object.entries(dt.motions).map(([g,m])=>fetch(m).then(c=>c.arrayBuffer()).then(c=>[g,c])))]),l=new ga(r);await l.init(e,{moc3:i,physics:s,textures:a,expressions:n,motions:o},{autoBlink:!0,...t}),window.parent.postMessage({type:"loaded",body:null},"*");const u=new Di,h=g=>{const m=g.x,c=g.y,d=r.getBoundingClientRect(),p=t.eyeX?t.eyeX:d.left+d.width/2,_=t.eyeY?t.eyeY:d.top+d.height/2,S=_a(m,c,p,_),b=Math.cos(S)*Math.sin(S)*180/Math.PI,f=da(m,c,p,_),y=p-m,P=_-c;Object.assign(u,{angleX:-y/10,angleY:P/10,angleZ:b*(f/p)/10,angleEyeX:-y/p/10,angleEyeY:P/_/2}),l.updatePoint(u)};return document.body.addEventListener("mousemove",g=>{h({x:g.clientX,y:g.clientY})},!1),window.addEventListener("message",g=>{const{type:m,body:c}=g.data;switch(m){case"setPos":break;case"moveCursor":h(c);break;default:break}},!1),l}catch(e){alert(e.message),console.error(e)}}(async()=>{const r=document.getElementById("canvas");if(r==null||!(r instanceof HTMLCanvasElement))throw new Error("Canvas element not found");const t=new URL(window.location.href),e=await ma(r,{scale:parseFloat(t.searchParams.get("scale")||"1"),x:parseFloat(t.searchParams.get("x")||"0"),y:parseFloat(t.searchParams.get("y")||"1"),eyeX:parseFloat(t.searchParams.get("eyeX")||"0"),eyeY:parseFloat(t.searchParams.get("eyeY")||"0")});if(e==null)throw new Error("Failed to load Live2D renderer");r.addEventListener("click",i=>{e?.click(i)})})();
